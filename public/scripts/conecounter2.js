function updateRunsCones(e,n,t,o){for(var s=0;s<queue.length;s++)if(queue[s]._id==e){queue[s].cones=o,queue[s].coneHits=n,queue[s].isDnf="dnf"==t,queue[s].isOff="off"==t,queue[s].getsRerun="rerun"==t;break}}function setCheck(){null==timerId&&(timerId=setTimeout(sync,1500))}function sync(){console.log("synching..."),console.log("queue len: "+queue.length);var e=queue.slice(0),n=starts.length;cleanRuns();for(var t=runs.length,o=0;(3>t?t:3)>o;o++)e.push(runs[o]);for(var o=0;o<e.length;o++)updateBtn(e[o],n>o);console.log("items; "+e.length);for(var s=$('a.cc-btn[runid!=""]'),o=0;o<s.length;o++){for(var c=$(s[o]).attr("runid"),i=!1,r=0;r<e.length;r++)if(c==e[r]._id){i=!0;break}i||clearBtnFromId(c)}timerId=null}function updateOnCourse(){console.log("updateoncourse");for(var e=starts.length,n=0;n<queue.length;n++)if(e>n){var t=$('a[runid="'+queue[n]._id+'"]');setBg(t,!1,!0,!1)}else{var t=$('a[runid="'+queue[n]._id+'"]');setBg(t,!0,!1,!1)}}function completeTodos(){for(var e=0;e<todos.length;e++)runs.push(todos[e]);cleanRuns()}function cleanRuns(){runs.sort(function(e,n){return e.runNumber>n.runNumber?-1:1});var e=runs.length,n=10;e>n&&(runs=runs.slice(0,n))}function getEmpties(){return $('a[runid=""]')}function setBg(e,n,t,o){e.toggleClass("inqueue",n).toggleClass("oncourse",t).toggleClass("finished",o)}function setBtn(e,n,t){t?setBg(e,!1,!0,!1):"Q"==n.status?setBg(e,!0,!1,!1):"F"==n.status&&setBg(e,!1,!1,!0);var o=e.find(".cones"),s=n.isDnf?"DNF":n.getsRerun?"RERUN":n.isOff?"OFF":"";""==s&&(s=n.cones>0?"+"+n.cones:""),o.text(s),""!=s?o.fadeIn("slow"):o.fadeOut("slow"),e.find(".num").text("#"+n.driver.carNumber),e.find(".name").text(n.driver.name),e.attr("runid",n._id),e.find(".axclass").html(n.axClass.name)}function updateBtn(e,n){console.log("updateBtn");var t=getEmpties();if(t.length>0){var o=$('a[runid="'+e._id+'"]');if(0==o.length){var s=$(t[0]);setBtn(s,e,n)}else setBtn(o,e,n)}}function clearBtnFromId(e){console.log("clearing btn for "+e);var n=$('a[runid="'+e+'"]');if(n.length>0){var t=n.attr("id").split("-")[1];clearBtn(t)}}function clearBtn(e){$("#cc-"+e).removeClass("oncourse").removeClass("inqueue").removeClass("finished"),$("#cc-"+e+" .cones").fadeOut("slow"),$("#cc-"+e+" .name").html("(empty)"),$("#cc-"+e+" .num").html("&nbsp;"),$("#cc-"+e+" .axclass").html("&nbsp;"),$("#cc-"+e).attr("runid","")}function init(){function e(e){return'<div class="cc-wrapper" id="ccw-'+e+'"><a id="cc-'+e+'" class="cc-btn ui-btn ui-shadow" runid=""><div class="cones hidden"></div><div class="axclass"></div><div class="num">&nbsp;</div><div class="name">(empty)</div></a></div>'}$("#cc-container").empty();for(var n=0;16>n;n++){var t=$(e(n));t.find("a").on("click",clickHandler),$("#cc-container").append(t)}}function searchQueue(e){for(var n=null,t=0;t<queue.length;t++)if(queue[t]._id==e){n=queue[t];break}return n}function searchRuns(e){for(var n=null,t=0;t<runs.length;t++)if(runs[t]._id==e){n=runs[t];break}return n}function search(e){var n=searchQueue(e);return null==n&&(n=searchRuns(e)),n}function clickHandler(){var e=$(this),n=(e.attr("id").split("-")[1],e.attr("runid"));if(""!=n){var t=search(n);null==t?alert("Something is out of sync, try refreshing your page."):(selectedRun=t,setDialog())}}function setDialog(){var e=selectedRun;$.mobile.changePage("#dlg-cones",{role:"dialog"});var n=[],t=0;$("#lbl-driver").text("#"+e.driver.carNumber+" - "+e.driver.name),selectedStation=0,$(".cc-pad-btn").toggleClass("ui-btn-active",!1).toggleClass("ui-btn-up-c",!1).toggleClass("ui-btn-down-c",!0);for(var o=0;o<e.coneHits.length;o++)n.push("Station #"+e.coneHits[o].station+" +"+e.coneHits[o].cones),0==e.coneHits[o].station&&(t=e.coneHits[o].cones),$("#cc-sta-"+e.coneHits[o].station).removeClass("ui-btn-down-c").addClass("ui-btn-up-c");t>0&&$("#cc-sta-0").addClass("ui-btn-active"),$("#pnl-stations").html('<div style="color:red;">'+n.join(", ")+"</div>"),$("input[name=radio-station]").checkboxradio("refresh"),$("#radio-cone-"+t).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh");var s=e.isDnf?"dnf":e.getsRerun?"rerun":e.isOff?"off":"none";$("#radio-pen-"+s).prop("checked",!0),$("input[name=radio-pen]").checkboxradio("refresh")}function saveCones(){console.log("saving cones");var e=parseInt($('input[name="radio-cone"]:checked').val()),n=selectedStation,t=$('input[name="radio-pen"]:checked').val();if(null!=selectedRun){var o={rid:selectedRun._id,cones:e,station:n,penalty:t,stream:"Q"==selectedRun.status?"queue":"runs"};socket.emit("conesadv",o),$("#pnl-cones").hide(),selectedRun=null,selectedStation=0}}var queueItems=[],runItems=[],showClassInNumber=!0,queueOrdering=-1,queue=[],runs=[];init();var socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"queue",eventId:eventId}),socket.emit("join",{stream:"chrono",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("message",function(e){$('<div class="msg-message ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><h1>Message</h1><p>'+e.message+"</p><p><a onclick=\"$('.msg-message').remove();\">Close</a></div>").css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)});var starts=[];socket.on("chrono",function(e){console.log("chrono data received: "+JSON.stringify(e)),starts=e.starts,updateOnCourse()}),socket.on("initq",function(e){console.log("initq"),queue=e,queue.sort(function(e,n){return e.runNumber<n.runNumber?-1:1});for(var n=0;n<queue.length;n++)updateBtn(queue[n])}),socket.on("addq",function(e){console.log("addq"),queue.push(e.run),updateBtn(e.run)}),socket.on("delq",function(e){console.log("delq"),console.log("queue len: "+queue.length);for(var n=[],t=0;t<queue.length;t++)queue[t]._id!=e&&(n.push(queue[t]),console.log("keep in queue"));queue=n,console.log(queue.length),updateRunsCones(),setCheck()}),socket.on("initr",function(e){console.log("initr"),runs=e,cleanRuns();for(var n=runs.length,t=0;(3>n?n:3)>t;t++)updateBtn(runs[t])}),socket.on("addr",function(e){console.log("addr");for(var n=!1,t=0;t<runs.length;t++)if(runs[t]._id==e._id){runs[t]=e,n=!0;break}n||runs.push(e),cleanRuns(),updateBtn(e),updateOnCourse()}),socket.on("delr",function(e){console.log("delr");for(var n=0;n<runs.length;n++)if(runs[n]._id==e){runs.splice(n,1);break}setCheck()}),socket.on("cones",function(e){console.log("not implemented")}),advancedMode&&socket.on("conesadv",function(e){console.log("conesadv");var n=e.penalty.toUpperCase();(""==n||"NONE"==n)&&(n=e.total>0?"+"+e.total:"");var t=$('a[runid="'+e.rid+'"] .cones').text(n);""!=n?t.fadeIn("slow"):t.fadeOut("slow");var o=searchQueue(e.rid);null==o&&(o=searchRuns(e.rid)),updateRunsCones(e.rid,e.coneHits,e.penalty,e.total)});for(var timerId=null,i=0;12>i;i++)clearBtn(i);var selectedStation=0;$(".cc-pad-btn").on("vclick",function(){var e=$(this);selectedStation=parseInt(e.attr("id").split("-")[2]),$(".cc-pad-btn").removeClass("ui-btn-active"),e.addClass("ui-btn-active");for(var n=!1,t=0;t<selectedRun.coneHits.length;t++)if(selectedStation==selectedRun.coneHits[t].station){$("#radio-cone-"+selectedRun.coneHits[t].cones).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh"),n=!0;break}n||($("#radio-cone-0").prop("checked","checked"),$("input[name=radio-cone]").checkboxradio("refresh"))});var selectedRun=null;$("#btn-savecones").on("vclick",saveCones);