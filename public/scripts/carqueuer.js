function addToQueueList(e,i){queue.push(e);var t="";void 0!=e.runGroup&&(t=e.runGroup.color);var r=showClassInNumber?e.axClass.name+" "+e.driver.carNumber:e.driver.carNumber,n='<li id="run-'+e._id+'"><a><div class="carnumber light">'+r+'</div><p class="list-rungroup conecount queue" style="background-color:'+t+'">&nbsp;</p><h3>'+e.driver.name+"</h3><p>"+e.driver.car.description+'</p><span class="ui-li-count">'+e.driverRunNumber+"</span></a></li>",a=$(n).data("run",e).bind("click",function(){selectedQueue=$(this).data("run"),$("#lbl-confirm").text(selectedQueue.driver.name+" #"+selectedQueue.driver.carNumber),$("#page-confirm").popup("open")}),d=$("#queuelist");d.append(a);var u=d.children();u.sort(function(e,i){return $(e).data("run").runNumber>$(i).data("run").runNumber?-1*queueOrdering:queueOrdering}),d.append(u)}function addToRunList(e,i){var t="",r="";void 0!=e.runGroup&&(r=e.runGroup.color);var n=showClassInNumber?e.axClass.name+" "+e.driver.carNumber:e.driver.carNumber;e.isDnf?t="DNF":e.isOff?t="OFF":e.getsRerun&&(t="RERUN");var a='<li id="run-'+e._id+'"><div class="carnumber">'+n+'</div><p class="list-rungroup conecount" style="background-color:'+r+'">&nbsp;</p><h3>'+e.driver.name+"</h3><p><strong>"+(null==e.rawTime?"":e.rawTime.toFixed(3))+(""!=t?" ("+t+")":"")+'</strong></p><p style="font-size:.7em;">'+e.driver.car.description+'</p><span class="ui-li-count">'+e.driverRunNumber+"</span></li>",d=$(a),u=$('#runlist li[id="run-'+e._id+'"]');u.length>0?u.replaceWith(d):i?$("#runlist").append(d):$("#runlist").prepend(d)}function delQueueItem(e){$("#queuelist li#run-"+e).remove();for(var i=[],t=0;t<queue.length;t++)queue[t]._id.toString()!=e.toString()&&i.push(queue[t]);queue=i}function delRunItem(e){$("#runlist li#run-"+e).remove()}function renumberQueue(){var e=$("#queuelist li"),i=0,t=e.length;if(invertOrder)for(var r=t-1;r>-1;r--){var n=0==i?"S":i+1;n=0==i?'1<sup style="font-size:.4em;">st</sup>':1==i?'2<sup style="font-size:.4em;">nd</sup>':2==i?'3<sup style="font-size:.4em;">rd</sup>':i+1+'<sup style="font-size:.4em;">th</sup>',i++,$(e[r]).find(".conecount").html(n)}else e.each(function(e,i){var t=0==e?"S":e+1;t=0==e?'1<sup style="font-size:.4em;">st</sup>':1==e?'2<sup style="font-size:.4em;">nd</sup>':2==e?'3<sup style="font-size:.4em;">rd</sup>':e+1+'<sup style="font-size:.4em;">th</sup>',$(this).find(".conecount").html(t)})}function dofilter(e){var i,t=$("#drivers"),r=(t.data("listview"),""),n=null;if(n=e.length<lastval.length||0!==e.indexOf(lastval)?t.children():t.children(":not(.ui-screen-hidden)"),lastval=e,e){for(var a=n.length-1;a>=0;a--)i=$(n[a]),r=i.jqmData("filtertext")||i.text(),i.is("li:jqmData(role=list-divider)")?(i.toggleClass("ui-filter-hidequeue",!childItems),childItems=!1):-1==r.indexOf(e)?i.toggleClass("ui-filter-hidequeue",!0):childItems=!0;n.filter(":not(.ui-filter-hidequeue)").toggleClass("ui-screen-hidden",!1),n.filter(".ui-filter-hidequeue").toggleClass("ui-screen-hidden",!0).toggleClass("ui-filter-hidequeue",!1)}else n.toggleClass("ui-screen-hidden",!1)}function memberClick(){socket.emit("addq",{carNumber:"",participantId:$(this).attr("id").split("-")[2],position:-1}),$("#lbl-carnum").text("Car #"),bigPadNumber="",$("#popup-multi").popup("close")}function bigPadAdd(){if(bigPadNumber.length>0){var e=[];for(var i in participants)participants[i].driver.carNumber.toString()==bigPadNumber.toString()&&e.push(participants[i]);if(0==e.length)socket.emit("addq",{carNumber:bigPadNumber,position:-1}),$("#lbl-carnum").text("Car #"),bigPadNumber="";else if(1==e.length)socket.emit("addq",{carNumber:"",participantId:e[0]._id,position:-1}),$("#lbl-carnum").text("Car #"),bigPadNumber="";else{var t=$("#popup-multi ul").empty();t.append('<li data-role="list-divider">Multiple Drivers with #'+bigPadNumber+"</li>");for(var i in e){var r=e[i],n=$('<li id="multinum-'+r.memberId+"-"+r._id+'"><a><h1>'+r.driver.name+"</h1><p>"+r.axClass.name+"</p><p>"+r.driver.car.description+"</p></a></li>").on("click",memberClick);t.append(n)}$("#popup-multi").popup("open"),t.listview("refresh")}}}function participantClickHandler(){var e=$(this).attr("id").split("-")[1],i=$("#ddl-insertbefore").val().replace("rid-","");socket.emit("addq",{carNumber:"",participantId:e,position:i}),$(".ui-dialog").dialog("close")}var selectedQueue=null,queue=[],invertOrder=!0,showClassInNumber=!0,queueOrdering=1,partsChanged=!1,socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"queue",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("disconnect",function(){$("#page-reconnect").popup("open")}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("message",function(e){$('<div class="msg-message ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><h1>Message</h1><p>'+e.message+'</p><p><a data-role="button" onclick="$(\'.msg-message\').remove();">Close</a></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("regchange",function(e){if("add"==e.action||"update"==e.action){var i=$("#dvrcon-"+e.data._id);if(i.length>0){var t=$('<li id="dvrcon-'+e.data._id+'"><a id="driver-'+e.data._id+'"><p class="list-rungroup" style="background-color:'+e.data.runGroup.color+'">&nbsp; <h3>'+e.data.driver.name+" - "+e.data.driver.carNumber+"</h3><p><strong>"+e.data.axClass.name+"</strong></h3><p>"+e.data.driver.car.description+"</p></a></li>");t.find("a").bind("click",participantClickHandler),i.replaceWith(t);for(var r=0;r<participants.length;r++)if(participants[r]._id.toString()==e.data._id.toString()){participants[r]=e.data;break}try{$("#drivers").listview("refresh")}catch(n){}partsChanged=!0}else{participants.push(e.data);var t='<li id="dvrcon-'+e.data._id+'" data-filtertext="'+e.data.driver.carNumber+" "+e.data.driver.name+" "+e.data.axClass.name+'"><a id="driver-'+e.data._id+'"><p class="list-rungroup" style="background-color:'+e.data.runGroup.color+'">&nbsp; <h3>'+e.data.driver.name+" - "+e.data.driver.carNumber+"</h3><p><strong>"+e.data.axClass.name+"</strong></h3><p>"+e.data.driver.car.description+"</p></a></li>",a=$(t).bind("click",participantClickHandler);$("#drivers").append(a),"page-addcar"==$.mobile.activePage.attr("id")?$("#drivers").listview("refresh"):partsChanged=!0}}else if("delete"==e.action){for(var d=[],r=0;r<participants.length;r++)participants[r]._id.toString()!=e.data&&d.push(participants[r]);participants=d,$("#dvrcon-"+e.data).remove()}}),socket.on("initq",function(e){$("#queuelist").empty();if(queue=[],e.length>0){for(var i=0;i<e.length;i++){var t=e[i];addToQueueList(t,invertOrder)}renumberQueue()}else $("#queuelist").append('<li id="ql-none"><h3>None</h3></li>');$("#queuelist").listview("refresh")}),socket.on("addq",function(e){$("#ql-none").remove(),addToQueueList(e.run,invertOrder),renumberQueue(),$("#queuelist").listview("refresh")}),socket.on("delq",function(e){delQueueItem(e),0==$("#queuelist li").length?($("#queuelist").append('<li id="ql-none"><h3>None</h3></li>'),$("#queuelist").listview("refresh")):renumberQueue()}),socket.on("cones",function(e){$("#run-"+e.rid+" p.list-conecount > span").hide().html(e.total).slideDown(300)}),socket.on("initr",function(e){$("#runlist").empty();if(e.length>0)for(var i=0;i<e.length;i++){var t=e[i];addToRunList(t,!0)}else $("#runlist").append('<li id="run-none"><h3>None</h3></li>');$("#runlist").listview("refresh")}),socket.on("addr",function(e){$("#run-none").remove(),$('#runlist li[id="run-'+e._id+'"]').remove(),addToRunList(e),$("#runlist").listview("refresh")}),socket.on("delr",function(e){delRunItem(e)});var dialogVisible=!1;$("#page-addcar").bind("pageshow",function(){partsChanged&&$("#drivers").listview("refresh"),partsChanged=!1,dialogVisible=!0}),$("#page-addcar").bind("pagehide",function(){dialogVisible=!1,$('input[data-type="search"]').val(""),$('input[data-type="search"]').trigger("keyup"),search="",lastval=""});var search="",lastval="",bigPadNumber="";$(".btn-bigpad").bind("click",function(){var e=$(this).text();"Add"==e?bigPadAdd():"Clear"==e?($("#lbl-carnum").text("Car #"),bigPadNumber=""):(bigPadNumber+=e.toString(),$("#lbl-carnum").text(bigPadNumber))}),$("#btn-reconnect").bind("click",function(){io.connect("http://"+window.location.host)}),$("#page-addcar .btn-number").bind("vclick",function(){var e=$(this).text();"clr"==e.toLowerCase()?search="":"del"==e.toLowerCase()?search=search.substr(0,search.length-1):search+=e.toString(),$('input[data-type="search"]').val(search),$('input[data-type="search"]').trigger("keyup")}),$("#btn-addcar").bind("vclick",function(){var e=[];e.push('<option value="-1" selected="selected">Last Position</option>');for(var i=0;i<queue.length;i++)e.push('<option value="rid-'+queue[i]._id+'">'+(0==i?"Start Line":i+1)+" - "+queue[i].driver.carNumber+" - "+queue[i].driver.car.description+" - "+queue[i].driver.name+"</option>");$("#ddl-insertbefore").html(e.join(""))});var addcarShown=!1;$("#page-addcar").bind("pagebeforeshow",function(){$("#ddl-insertbefore").selectmenu("refresh")}),$("#drivers a").bind("click",participantClickHandler),$("#btn-confirm").bind("click",function(){socket.emit("delq",selectedQueue._id),selectedQueue=null}),$("#page-confirm").bind("popupafterclose",function(){selectedQueue=null}),$(document).on("keydown",function(e){if(e.which>47&&e.which<58&&!dialogVisible){var i=e.which-48;bigPadNumber+=i.toString(),$("#lbl-carnum").text(bigPadNumber)}else if(e.which>95&&e.which<106&&!dialogVisible){var i=e.which-96;bigPadNumber+=i.toString(),$("#lbl-carnum").text(bigPadNumber)}else 8!==e.which&&46!==e.which||$(e.target).is("input, textarea")?13!=e.which||dialogVisible||bigPadNumber.length>0&&bigPadAdd():(e.preventDefault(),bigPadNumber=bigPadNumber.substring(0,bigPadNumber.length-1),$("#lbl-carnum").text(bigPadNumber))});