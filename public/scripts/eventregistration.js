function searchClassRunGroups(e,r){for(var a=classRunGroups.length-1;a>=0;a--){var t=classRunGroups[a];if(r&&t.paxClass==r)return t.runGroup;if(e&&t.baseClass==e)return t.runGroup}return null}function setRunGroup(e,r){if(classRunGroups.length>0){var a=searchClassRunGroups(e,r);$("input[name=drv-rungroup]").prop("checked",!1).checkboxradio("refresh"),a&&$("#drv-rungroup-"+a).prop("checked",!0).checkboxradio("refresh")}}var selectedParticipant=null,classes=[],participants=[],drivers=[],selectedEvent=null,selectedDriver=null,members=[],socket;$("#page-registration").bind("pageinit",function(){function e(e){$.ajax({url:"/api/"+e+"/members",type:"GET",dataType:"json",success:function(e){if(null!=e){members=e.items;var a=[];$.each(members,function(e,r){var t=r.firstName+" "+r.lastName,n=r.lastAxClass.length>0?r.lastAxClass+" ":"";r.lastPaxClass.length>0&&n.length>0&&(n=r.lastPaxClass+"-"+n);var i=r.clubMemberId?"Member: "+r.clubMemberId:"&nbsp;";a.push('<li data-filtertext="'+r.dedicatedNumber+" "+t+'"><a id="reg-driver-list_'+e+'"><div style="position:absolute;font-size:50px;opacity:.3;right:20%;font-style:italic;">'+n+r.dedicatedNumber+"</div><h3>"+t+"</h3><p>"+i+"</p></a></li>")}),$("#reg-driverlist").html(a.join("")).find("a").on("click",r)}}})}function r(){var e=parseInt($(this).attr("id").split("_")[1]),r=members[e];if($("#drv-fname").val(r.firstName),$("#drv-lname").val(r.lastName),$("#drv-carnum").val(r.dedicatedNumber),$("#drv-email").val(r.currentEmail),$("#drv-memnum").val(r.clubMemberId),$("#drv-memberId").val(r._id),$("#drv-carmake").val(""),$("#drv-carmodel").val(""),$("#drv-caryear").val(""),$("#drv-carcolor").val(""),0==r.cars.length)$("#box-cars").hide();else if(1==r.cars.length)$("#box-cars").hide(),$("#drv-carmake").val(r.cars[0].make),$("#drv-carmodel").val(r.cars[0].model),$("#drv-caryear").val(r.cars[0].year),$("#drv-carcolor").val(r.cars[0].color);else{$("#box-cars").show(),$("#drv-cars").empty().data("cars",r.cars).append('<option value="car-0" selected="selected">Select One or Input Below</option>');for(var a=0;a<r.cars.length;a++){var t=r.cars[a];$("#drv-cars").append('<option value="car-'+(a+1)+'">'+t.description+"</option>")}}if($("#lbl-driveredit").text("Create Participant"),$.mobile.changePage("#page-newdriver",{role:"dialog"}),$("#drv-cars").selectmenu("refresh"),r.lastAxClass.indexOf("-")>-1){var n=r.lastAxClass.split("-");$("#drv-class").val(n[1]),$("#drv-class").selectmenu("refresh"),$("#drv-paxclass").val(n[0]),$("#drv-paxclass").selectmenu("refresh"),setRunGroup(null,n[0])}else $("#drv-class").val(r.lastAxClass),$("#drv-paxclass").val(r.lastPaxClass),$("#drv-class").selectmenu("refresh"),$("#drv-paxclass").selectmenu("refresh"),$("input[name=drv-rungroup]").prop("checked",!1).checkboxradio("refresh"),setRunGroup(r.lastAxClass)}function a(e){var r=$("#drv-fname").val(),a=$("#drv-lname").val(),t=r+" "+a,n=$("#drv-carnum").val(),i=$("#drv-carmake").val(),s=$("#drv-carmodel").val(),c=$("#drv-caryear").val(),l=$("#drv-carcolor").val(),d=$("#drv-class").val(),o=$("input[name=drv-rungroup]:checked").val(),v=$("input[name=drv-role]:checked").val(),p=$("#drv-paid").val(),u=$("#drv-checkin").val(),m=null==selectedParticipant?"":selectedParticipant._id,h=$("#drv-memberId").val(),f=$("#drv-paxclass").val(),g=$("#drv-memnum").val(),b=g.length>0,k="yes"==$("input[name=drv-applyexistingruns]:checked").val(),x="yes"==$("input[name=drv-rookie]:checked").val(),y=$("#drv-email").val(),w=!0,C="";0==t.replace(" ","").length&&(w=!1,C+="You must provide a Full Name.\n"),0==n.replace(" ","").length&&(w=!1,C+="You must provide a Car Number.\n"),0==d.length&&(w=!1,C+="You must provide a Class.\n"),w?$.ajax({url:"/api/participants/"+eventId,type:"POST",dataType:"json",data:{name:t,fname:r,lname:a,carnum:n,carmake:i,carmodel:s,caryear:c,carcolor:l,axclass:d,rungroup:o,role:v,paid:p,partId:m,memberId:h,paxClass:f,checkin:u,isMember:b,memberNumber:g,applyToExistsingRuns:k,email:y,isRookie:x},success:function(r){"success"==r.status?($("#drv-fname").val(""),$("#drv-lname").val(""),$("#drv-carnum").val(""),$("#drv-carmake").val(""),$("#drv-carmodel").val(""),$("#drv-caryear").val(""),$("#drv-carcolor").val(""),$("#drv-memnum").val(""),$("#drv-email").val(""),$("input[name=drv-applyexistingruns]").prop("checked",!1).checkboxradio("refresh"),$("input[name=drv-rookie]").prop("checked",!1).checkboxradio("refresh"),$.mobile.changePage("#page-registration",{transition:"none"}),e&&e(r.item._id)):($("#error-msg").text(r.message),$.mobile.changePage("#popup-msg",{role:"dialog"}))}}):alert(C)}function t(e){selectedParticipant=e,$("#lbl-driveredit").text("Edit Participant");var r=null;for(var a in members)if(members[a]._id==e.memberId.toString()){r=members[a];break}if(null==r&&$("#box-cars").hide(),0==r.cars.length)$("#box-cars").hide();else if(1==r.cars.length)$("#box-cars").hide();else{$("#box-cars").show(),$("#drv-cars").empty().data("cars",r.cars).append('<option value="car-0" selected="selected">Select One or Input Below</option>');for(var a=0;a<r.cars.length;a++){var t=r.cars[a];$("#drv-cars").append('<option value="car-'+(a+1)+'">'+t.description+"</option>")}}if(void 0===e.driver.firstName||0==e.driver.firstName.length){var n=e.driver.name.split(" ");$("#drv-fname").val(n.shift()),$("#drv-lname").val(n.join(" "))}else $("#drv-fname").val(e.driver.firstName),$("#drv-lname").val(e.driver.lastName);$("#drv-carnum").val(e.driver.carNumber),$("#drv-carmake").val(e.driver.car.make),$("#drv-carmodel").val(e.driver.car.model),$("#drv-caryear").val(e.driver.car.year),$("#drv-carcolor").val(e.driver.car.color),$("#drv-memberId").val(e.memberId),$("#drv-email").val(e.driver.currentEmail),$("#drv-memnum").val(e.driver.clubMemberId),$("#drv-paid").val(e.paid?"yep":"nope"),$("#drv-checkin").val(e.checkedIn?"yep":"nope");var i=e.axClass.name,s="";i.indexOf("-")>-1&&(s=e.axClass.name.split("-")[0],i=e.axClass.name.split("-")[1]),$("#drv-class").val(i),$("#drv-paxclass").val(e.axClass.paxClass);var c=$("input[name=drv-rungroup]").removeAttr("checked"),l=$("input[name=drv-role]").removeAttr("checked");$.mobile.changePage("#page-newdriver",{transition:"none",rel:"dialog"}),$("#drv-paid").slider("refresh"),$("#drv-checkin").slider("refresh"),$("#drv-cars").selectmenu("refresh"),$("input[id=drv-rungroup-"+e.runGroup.name+"]").prop("checked",!0),c.checkboxradio("refresh"),$('input[id="drv-role-'+e.workerRole+'"]').prop("checked",!0),l.checkboxradio("refresh"),$("input[name=drv-rookie]").prop("checked",e.isRookie).checkboxradio("refresh"),$("#drv-class").selectmenu("refresh"),$("#drv-paxclass").selectmenu("refresh"),$("#drv-btn-save").find("span.ui-btn-text").text("Save Driver"),setRunGroup(i,s)}function n(e){var r="",a="",n="&nbsp;";e.runGroup?(r=" rungroup:"+e.runGroup.name,a=e.runGroup.color,n=e.runGroup.label||"&nbsp;"):(r=" rungroup:none",a="&nbsp;");var i='<li id="p-'+e._id+'" data-filtertext="'+e.driver.carNumber+" "+e.driver.name+r+" "+(e.checkedIn?"checkedin:yes":"checkedin:no")+" "+(e.paid?"paid:yes":"paid:no")+" "+(e.isTechd?"tech:yes":"tech:no")+'"><a><div style="position:absolute;font-size:50px;opacity:.3;right:20%;font-style:italic;">'+e.driver.carNumber+'</div><p style="float:left;font-size:24px;line-height:30px;margin:.3em .3em .3em 0;color:#fff;text-align:center;background-color:'+a+';width:40px;">'+n+"</p><h3>"+e.driver.name+("None"!=e.workerRole?" ("+e.workerRole+")":"")+"</h3><p>"+e.driver.car.description+"</p><p>"+(e.paid?"Paid":"NOT PAID")+'</p><p class="ui-li-aside"><strong>'+e.axClass.name+"</strong><br/>"+(e.checkedIn?"Checked In":"NOT Checked In")+"<br/>"+(void 0!==e.station?e.station:"")+"</p></a></li>",s=$(i).data("part",e).bind("click",function(){var e=$(this).data("part");t(e)});return s}function i(){var e=participants;$("#reg-partlist").empty(),$.each(e,function(e,r){var a=n(r);$("#reg-partlist").append(a)}),$("#reg-partlist").listview("refresh"),$("#lbl-count").text(" ("+e.length+")")}e(clubname),$("#btn-shownewdriver").click(function(){selectedParticipant=null,$("#lbl-driveredit").text("Create New Participant"),$("#drv-memberId").val(""),$("#drv-fname").val(""),$("#drv-lname").val(""),$("#drv-carnum").val(""),$("#box-cars").hide(),$("#drv-carmake").val(""),$("#drv-carmodel").val(""),$("#drv-caryear").val(""),$("#drv-carcolor").val(""),$("input[name=drv-rookie]").prop("checked",!1).checkboxradio("refresh"),$("#drv-memnum").val(""),$("#drv-email").val(""),$("#drv-class").val("").selectmenu("refresh"),$("#drv-paxclass").val("").selectmenu("refresh"),$("input[name=drv-rungroup]").prop("checked",!1).checkboxradio("refresh"),$("input[name=drv-role]:first").prop("checked",!0).checkboxradio("refresh"),$("input[name=drv-role]").checkboxradio("refresh"),$("#drv-btn-save").find("span.ui-btn-text").text("Create Driver")}),$("#drv-cars").bind("change",function(){var e=$(this).data("cars"),r=parseInt($("#drv-cars option:selected").val().split("-")[1])-1;if(r>-1){var a=e[r];$("#drv-carmake").val(a.make),$("#drv-carmodel").val(a.model),$("#drv-caryear").val(a.year),$("#drv-carcolor").val(a.color)}else $("#drv-carmake").val(""),$("#drv-carmodel").val(""),$("#drv-caryear").val(""),$("#drv-carcolor").val("")}),$("#drv-btn-save").click(function(){a()}),$("#drv-btn-savelabel").bind("click",function(){a(function(e){var r="http://"+window.location.host;r+="/event/"+eventId+"/printlabel/"+e,window.open(r,"printerlabel")})}),socket=io(),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){socket.emit("join",{stream:"reg",eventId:eventId}),$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("disconnect",function(){$("#page-reconnect").popup("open")}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("message",function(e){$('<div class="msg-message ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><h1>Message</h1><p>'+e.message+'</p><p><a data-role="button" onclick="$(\'.msg-message\').remove();">Close</a></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("initreg",function(e){participants=e.participants,i()}),socket.on("regchange",function(e){if("add"==e.action||"update"==e.action){if("add"==e.action&&null!=e.member){for(var r=!1,a=0;a<members.length;a++)if(e.member._id.toString()==members[a]._id.toString()){r=!0;break}r||members.push(e.member)}var t=$("li#p-"+e.data._id);if(t.length>0){var i=n(e.data);t.replaceWith(i);for(var a=0;a<participants.length;a++)if(participants[a]._id.toString()==e.data._id.toString()){participants[a]=e.data;break}$("#reg-partlist").listview("refresh")}else{participants.push(e.data);var s=n(e.data);$("#reg-partlist").append(s),$("#reg-partlist").listview("refresh")}$("#part-search input").trigger("keyup")}else if("delete"==e.action){for(var c=[],a=0;a<participants.length;a++)participants[a]._id.toString()!=e.data&&c.push(participants[a]);participants=c,$("li#p-"+e.data).remove()}$("#lbl-count").text(" ("+participants.length+")")})}),$("#page-registration").bind("pageshow",function(){$("#reg-partlist").listview("refresh")}),$("#page-newdriver").bind("pageshow",function(){$("#drv-class").selectmenu("refresh")}),$("#page-newdriver").bind("pagehide",function(){selectedParticipant=null}),$("#page-adddriver").bind("pageshow",function(){$("#reg-driverlist").listview("refresh")}),$("#btn-sort-car").bind("vclick",function(){var e=$("#reg-partlist li");e.sort(function(e,r){var a=parseInt($(e).data("part").driver.carNumber),t=parseInt($(r).data("part").driver.carNumber);return t>a?-1:a>t?1:0}),$("#reg-partlist").append(e)}),$("#btn-sort-name").bind("vclick",function(){var e=$("#reg-partlist li");e.sort(function(e,r){var a=$(e).data("part").driver.name.toLowerCase(),t=$(r).data("part").driver.name.toLowerCase();return t>a?-1:a>t?1:0}),$("#reg-partlist").append(e)}),$("#btn-sort-group").bind("vclick",function(){var e=$("#reg-partlist li");e.sort(function(e,r){var a=$(e).data("part").runGroup.name,t=$(r).data("part").runGroup.name;return t>a?-1:a>t?1:0}),$("#reg-partlist").append(e)}),$("#drv-class").on("change",function(){var e=$(this).val(),r=$("#drv-paxclass").val();e&&!r&&setRunGroup(e)}),$("#drv-paxclass").on("change",function(){var e=$(this).val(),r=$("#drv-class").val();e?setRunGroup(null,e):r&&setRunGroup(r)}),$(".search-filter").on("vclick",function(){var e=$(this),r=e.attr("id").split("-")[2],a="";switch(r){case"checkin":a="checkedin:yes";break;case"notcheckin":a="checkedin:no";break;case"paid":a="paid:yes";break;case"notpaid":a="paid:no";break;case"techd":a="tech:yes";break;case"nottechd":a="tech:no";break;case"rg":var t=e.attr("id").split("-")[3];a="rungroup:"+t;break;default:a=""}$("#part-search input").val(a).trigger("keyup")}),$("#btn-delete").bind("vclick",function(){null!=selectedParticipant&&$.ajax({url:"/api/participants/"+selectedParticipant._id,type:"DELETE",dataType:"json",success:function(e){if("success"==e.status){for(var r=[],a=0;a<participants.length;a++)selectedParticipant._id.toString()!=participants[a]._id.toString()&&r.push(participants[a]);participants=r,$("#p-"+selectedParticipant._id).remove(),$.mobile.changePage("#page-registration",{transition:"none"}),$("#lbl-count").text(" ("+participants.length+")")}}})});