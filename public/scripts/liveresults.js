function ttoditem(t,s,a,e,r){return'<li data-role="list-divider">'+t+'</li><li><div style="position:absolute;font-size:50px;opacity:.3;right:20%;font-style:italic;">'+a+'</div><span class="ui-li-aside">'+e+'</span><h3 class="ui-li-heading">'+s+"</h3><p>"+r+" </p></li>"}function genTtod(){if(null!=ttod){var t=ttoditem("Overall",ttod.ttod.driver,ttod.ttod.carNumber,ttod.ttod.time,ttod.ttod.car)+ttoditem("PAX",ttod.pax.driver,ttod.pax.carNumber,ttod.pax.time,ttod.pax.car)+ttoditem("Mens",ttod.mens.driver,ttod.mens.carNumber,ttod.mens.time,ttod.mens.car)+ttoditem("Womens",ttod.womens.driver,ttod.womens.carNumber,ttod.womens.time,ttod.womens.car)+ttoditem("Stock",ttod.showroomStock.driver,ttod.showroomStock.carNumber,ttod.showroomStock.time,ttod.showroomStock.car)+ttoditem("FUN",ttod.fun.driver,ttod.fun.carNumber,ttod.fun.time,ttod.fun.car)+ttoditem("Cone Killer",ttod.coneKiller.driver,ttod.coneKiller.carNumber,ttod.coneKiller.count,ttod.coneKiller.car)+ttoditem("Lost (DNFs)",ttod.dnfs.driver,ttod.dnfs.carNumber,ttod.dnfs.count,ttod.dnfs.car)+ttoditem("Reruns",ttod.reruns.driver,ttod.reruns.carNumber,ttod.reruns.count,ttod.reruns.car);$("#ttodresults").empty().append(t),"page-ttod"==$($.mobile.activePage).attr("id")&&$("#ttodresults").listview("refresh")}}function getResultHtml(t){var s=t.bestTime;return""!=t.axClass.paxClass&&(s=t.bestPaxTime),html='<li id="p-'+t._id+'" class="'+(0==t.rankPax?"paxexclude":"")+" "+(0==t.rankOverall?"rawexclude":"")+" "+(0==t.rankClass?"classexclude":"")+'"><a><div class="carnumber">'+t.driver.carNumber+'</div><div style="float:left;margin-right:12px;text-align:center;"><span class="rank rawrank">'+t.rankOverall+'</span><span class="rank paxrank" style="color:red;">'+t.rankPax+'</span><span class="rank classrank">'+t.rankClass+'</span><br/><div style="font-size:.6em;margin-top:-11px;">'+t.rankOverall+"-"+t.rankClass+"-"+t.rankPax+'</div></div><h3 class="ui-li-heading">'+t.driver.name+'</h3><p style="font-size:1.2em;"><span class="time rawtime">'+t.bestTime.toFixed(3)+(t.rankOverall>1?'<span style="color:red;"> +'+t.diffOverall+'</span><span style="color:red;font-size:.8em;"> +'+t.diffPrevOverall+"</span>":"")+'</span><span class="time paxtime">'+t.bestPaxTime.toFixed(3)+(t.rankPax>1?'<span style="color:red;"> +'+t.diffPax+'</span><span style="color:red;font-size:.8em;"> +'+t.diffPrevPax+"</span>":"")+'</span><span class="time classtime">'+s.toFixed(3)+(t.rankClass>1?'<span style="color:red;"> +'+t.diffClass+'</span><span style="color:red;font-size:.8em;"> +'+t.diffPrevClass+"</span>":"")+'</span></p><p class="ui-li-desc details">DNFs: '+t.totalDnfs+", Re-runs:"+t.totalReruns+", Cones:"+t.totalCones+"</br>"+t.axClass.name+'</p><span class="ui-li-count">'+t.totalCountedRuns+"</span></a></li>"}function genResults(){participants.sort(function(t,s){var a=t.rankOverall,e=s.rankOverall;return e>a?-1:a>e?1:0}),$("#resulttimes").empty();for(var t=0;t<participants.length;t++){var s=participants[t],a=(s.rankOverall,getResultHtml(s)),e=$(a).data("part",s).bind("vclick",showDriver);$("#resulttimes").append(e)}"pax"==sort?sortPax():"class"==sort&&sortClass(selectedClass),$("#resulttimes").listview("refresh")}function sortPax(){sort="pax";var t=$("#resulttimes li").removeClass("ui-screen-hidden").sort(function(t,s){var a=$(t).data("part").rankPax,e=$(s).data("part").rankPax;return e>a?-1:a>e?1:0});$("#resulttimes").removeClass("rank-overall rank-class").addClass("rank-pax").append(t)}function sortRaw(){sort="overall";var t=$("#resulttimes li").removeClass("ui-screen-hidden").sort(function(t,s){var a=$(t).data("part").rankOverall,e=$(s).data("part").rankOverall;return e>a?-1:a>e?1:0});$("#resulttimes").removeClass("rank-pax rank-class").addClass("rank-overall").append(t)}function popClases(){for(var t=[],s=0;s<participants.length;s++){var a=participants[s],e=!1,r=a.axClass.name;r.indexOf("-")>-1&&(r=a.axClass.name.split("-")[0]);for(var n=0;n<t.length;n++)if(r==t[n]){e=!0;break}e||t.push(r)}t.sort(),classes=t,$("#classlist").empty();for(var s=0;s<classes.length;s++){var i=classes[s],l=$('<li id="cls-'+i+'"><a class="ui-btn ui-btn-up-c">'+i+"</a></li>").bind("click",function(){var t=$(this).attr("id").split("-")[1];selectedClass=t,$("#classlist").hide(),$("#btn-classselect").show(),$("#resulttimes").show(),sortClass(t)});$("#classlist").append(l)}}function sortClass(t){if(sort="class",null==selectedClass)$("#classlist").show();else{for(var s=$("#resulttimes li").sort(function(t,s){var a=$(t).data("part").rankClass,e=$(s).data("part").rankClass;return e>a?-1:a>e?1:0}),a=0;a<s.length;a++)$(s[a]).data("part").axClass.name.split("-")[0]!=t||0==$(s[a]).data("part").rankClass?$(s[a]).addClass("nonclass"):$(s[a]).removeClass("nonclass");$("#resulttimes").removeClass("rank-pax rank-overall").addClass("rank-class").append(s)}}function showDriver(){var t=$(this).data("part")._id;$.mobile.changePage("#page-driver",{role:"dialog"}),$.ajax({url:"/api/driver/"+t,type:"GET",dataType:"json",success:function(t){if("success"==t.status){for(var s=[],a=t.participant,e=0;e<t.runs.length;e++){var r=t.runs[e],n=r.isDnf||r.isOff?' data-theme="a" data-icon="delete"':r.getsRerun?' data-theme="e" data-icon="alert"':' data-icon="false"';a.bestTime==r.totalTime&&(n=' data-theme="b" data-icon="check"');var i=[];if(r.coneHits.length>0)for(var l in r.coneHits)i.push("Station #"+r.coneHits[l].station+": "+r.coneHits[l].cones);s.push("<li"+n+'><a href="#"><h1>Run '+r.driverRunNumber+" - "+r.totalTime.toFixed(3)+"</h1><p>Session: "+r.session+", Run Group: "+r.runGroup.name+(i.length>0?"<br/>CONE HITS: "+i.join(", "):"")+(r.splitTimes.length>0?"<br/>Split Times: "+r.splitTimes.join(", "):"")+'</p><span class="ui-li-count">'+r.cones+"</span></a></li>")}0==s.length&&s.push("<li>No runs yet</li>"),$("#driver-runs").html('<li data-role="list-divider">Runs</li>'+s.join("")).listview("refresh"),$("#rankclass").text(ranktext(a.rankClass)),$("#rankoverall").text(ranktext(a.rankOverall)),$("#rankpax").text(ranktext(a.rankPax)),$("#drivername").text(a.driver.name),$("#lastupdated").text(""),$("#runcount").text(t.runs.length),$("#dtclass").text(a.axClass.name),$("#driverinfo").html("Car: <strong>"+(a.driver.car.year>0?a.driver.car.year+" ":"")+a.driver.car.description+"</strong><br/>Number: <strong>"+a.driver.carNumber+"</strong><br/>Run Group:<strong>"+a.runGroup.name+"</strong>")}}})}function ranktext(t){return 1==t?"1st":2==t?"2nd":3==t?"3rd":t+"th"}var sort="overall",classes=[],selectedClass=null,socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"results",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"results",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})});var ttod=null,participants=null;socket.on("message",function(t){$('<div class="msg-message ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Message</h1><p>'+t.message+"</p><p><a onlick=\"$('.msg-message').remove();\">Close</a></div>").css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("results",function(t){if("full"==t.type)ttod=t.ttods,participants=t.participants,popClases(),genResults(),genTtod();else if("incr"==t.type){for(var s=0;s<t.participants.length;s++){for(var a=!1,e=t.participants[s],r=0;r<participants.length;r++)if(participants[r]._id==t.participants[s]._id){a=!0,participants[r]=e;var n=getResultHtml(e),i=$(n).data("part",e).bind("vclick",showDriver),l=$("#p-"+e._id);l.length>0?l.replaceWith(i):$("#resulttimes").append(i)}if(!a){participants.push(e);var n=getResultHtml(e),i=$(n).data("part",e).bind("vclick",showDriver);$("#resulttimes").append(i)}}$("#resulttimes").listview("refresh"),"pax"==sort?sortPax():"class"==sort?sortClass(selectedClass):sortRaw(),null!=t.ttods&&(ttod=t.ttods,genTtod())}else if("update"==t.type){for(var s=0;s<t.participants.length;s++){for(var a=!1,r=0;r<participants.length;r++)if(participants[r]._id==t.participants[s]._id){var e=t.participants[s];participants[r].totalCones=e.totalCones,participants[r].totalDnfs=e.totalDnfs,participants[r].totalReruns=e.totalReruns,participants[r].totalRuns=e.totalRuns,participants[r].totalCountedRuns=e.totalCountedRuns;var o=$("#p-"+e._id);o.find(".details").html("DNFs: "+e.totalDnfs+", Re-runs:"+e.totalReruns+", Cones:"+e.totalCones+"</br>"+e.axClass.name),$("#p-"+e._id).find(".ui-li-count").text(e.totalCountedRuns),a=!0;break}a||participants.push(t.participants[s])}null!=t.ttods&&(ttods=t.ttods,genTtod())}$("#results-lastupdated").text((new Date).toLocaleTimeString())}),$("#btn-pax").bind("click",function(){$("#classlist").hide(),$("#btn-classselect").hide(),$("#resulttimes").show(),sortPax(),$('#resultspanel input[data-type="search"]').val("")}),$("#btn-raw").bind("click",function(){$("#classlist").hide(),$("#btn-classselect").hide(),$("#resulttimes").show(),$('#resultspanel input[data-type="search"]').val(""),sortRaw()}),$("#btn-class").bind("click",function(){null==selectedClass?($("#classlist").show(),$("#btn-classselect").hide(),$("#resulttimes").hide()):(sortClass(selectedClass),$("#btn-classselect").show()),$('#resultspanel input[data-type="search"]').val("")}),$("#btn-classselect").bind("click",function(){selectedClass=null,$("#classlist").show(),$("#btn-classselect").hide(),$("#resulttimes").hide()}),$("#btn-showdetails").bind("click",function(){$(this).toggleClass("ui-btn-active"),$("#resulttimes").toggleClass("nodetails")}),$("#page-liveresults").bind("pageinit",function(){$("#btn-classselect").hide(),$("#classlist").hide()}),$("#page-search").bind("pageinit",function(){for(var t=0;t<participants.length;t++){var s=participants[t],a=$('<li data-part="'+s._id+'"><a><div class="carnumber">'+s.driver.carNumber+"</div><h3>"+s.driver.name+"</h3><p>"+s.driver.car.description+"</p></a></li>").data("part",{_id:s._id}).bind("click",showDriver);$("#driversearch").append(a)}$("#driversearch").listview("refresh")}),$("#page-ttod").bind("pageshow",function(){$("#ttodresults").listview("refresh")});