function regenTtod(){for(var t=null,e=null,s=0;s<participants.length;s++){var a=participants[s];a.bestTime>0&&a.bestTime<999&&(null===t?t=a:a.bestTime<t.bestTime&&(t=a)),a.bestPaxTime>0&&a.bestPaxTime<999&&(null===e?e=a:a.bestPaxTime<e.bestPaxTime&&(e=a))}var n=[];null!=t&&n.push('<span style="font-weight:bold;">TOP TIME: </span>'+t.driver.name+", #"+t.driver.carNumber+", "+t.bestTime),null!=e&&n.push('<span style="font-weight:bold;padding-left:32px;">TOP PAX: </span>'+e.driver.name+", #"+e.driver.carNumber+", "+e.bestPaxTime),0==n.length&&n.push("No valid times yet"),$("#ttod").html(n.join(""))}function doClasses(){for(var t=[],e=0;e<classList.length;e++)t.push('<li data-icon="info"><a href="#classpopup" data-rel="popup" id="cls-'+classList[e]+'">'+classList[e]+"</a></li>");$("#classList").empty().append(t.join("")).find("a").bind("click",function(){var t=$(this).attr("id").split("-")[1];$("#classpopupdata").html('<div style="font-weight:normal">'+getClassRankings(t)+"</div>"),refreshParticipantClick()}),$("#classList").listview("refresh")}function getClassRankings(t,e){for(var s=[],a=!1,n=0;n<participants.length;n++){var i=participants[n],r=i.axClass.name;i.rankClass>0&&(""!=i.axClass.paxClass&&(r=i.axClass.paxClass,a=!0),t==r&&s.push(i))}s.sort(function(t,e){return t.rankClass>e.rankClass?1:-1});var d=[];d.push('<table width="100%" cellspacing="0" cellpadding="3"><tr><td><strong>Rank</strong></td><td><strong>Driver</strong></td>'+(a?"<td><strong>Class</strong></td>":"")+"<td><strong>Best</strong></td><td><strong>Diff</strong></td></tr>");for(var n=0;n<s.length;n++){var i=s[n],l="";i._id.toString()==e&&(l=' class="ui-btn-up-b"'),d.push("<tr"+l+'><td style="font-size:1.4em;font-weight:bold;text-align:center">'+getRank(i.rankClass)+"</td>"),d.push('<td><a href="#popuppart" data-rel="popup" data-pid="'+i._id+'" id="cr-'+i._id+'" class="participant"><strong>'+i.driver.name+'</strong></a><br/><span style="font-size:.9em;">'+i.driver.car.description+"</span></td>"),a&&d.push("<td>"+i.axClass.name+"</td>");var o=i.bestTime,p=i.diffClass,u=i.diffPrevClass;""!=i.axClass.paxClass&&(o=i.bestPaxTime),d.push("<td>"+o.toFixed(3)+"</td>"),d.push("<td>"+p.toFixed(3)+'<div style="font-size:.8em;">'+u.toFixed(3)+"</div></td>"),d.push("</tr>")}return d.push("</table>"),d.join("")}function setClasses(){for(var t=[],e=0;e<participants.length;e++){var s=participants[e],a=s.axClass.name;s.rankClass>0&&(""!=s.axClass.paxClass&&(a=s.axClass.paxClass),-1==t.indexOf(a)&&t.push(a))}t.sort(),classList=t}function getRank(t){var e=t.toString().substring(t.length-1),s=t+'<sup style="font-size:.5em;">th</sup>';return 1==e?s=t+'<sup style="font-size:.5em;">st</sup>':2==e?s=t+'<sup style="font-size:.5em;">nd</sup>':3==e&&(s=t+'<sup style="font-size:.5em;">rd</sup>'),s}function refreshParticipantClick(){$(".participant").unbind("click").bind("click",function(){var t=$(this).data("pid");getParticipant(t)})}function updateInQueue(){var t=[];t.push('<div style="float:left;font-size:1.6em;font-weight:bold;">Next to Finish:</div>');for(var e=0;e<queue.length;e++)e>0&&t.push('<div class="ui-body-d" style="float:left;margin-left:20px;padding:5px;"><a href="#popuppart" data-rel="popup" class="participant" data-pid="'+queue[e].participantId+'"><strong>'+queue[e].driver.name+" - "+queue[e].axClass.name+" #"+queue[e].driver.carNumber+'</strong></a><br/><span style="font-size:.9em;">'+queue[e].driver.car.description+"</span></div>");$("#inqueue").html(t.join("")),refreshParticipantClick()}function getParticipant(t){$.ajax({url:"/api/driverinfo/"+eventId,dataType:"json",data:{participantId:t},success:function(t){if("success"==t.status){var e=t.participant,s=[];s.push('<div style="float:left;margin-right:18px;">'),s.push('<div style="font-size:1.5em;font-weight:bold">'+e.driver.name+"</div>"),s.push("<div><strong>"+e.axClass.name+" #"+e.driver.carNumber+"</strong></div>"),s.push("<div>"+e.driver.car.description+"</div>"),s.push("<p></p>");var a='<table width="100%"><tr><td style="color:gray;">Overall: </td><td><strong>'+getRank(e.rankOverall)+"</strong></td><td><span>+"+e.diffOverall.toFixed(3)+'</span> <span style="font-size:.8em;">+'+e.diffPrevOverall.toFixed(3)+'</span></td></tr><tr><td style="color:gray;">Class: </td><td><strong>'+getRank(e.rankClass)+"</strong></td><td><span>+"+e.diffClass.toFixed(3)+'</span> <span style="font-size:.8em;">+'+e.diffPrevClass.toFixed(3)+'</span></td></tr><tr><td style="color:gray;">PAX: </td><td><strong>'+getRank(e.rankPax)+"</strong></td><td><span>+"+e.diffPax.toFixed(3)+'</span> <span style="font-size:.8em;">+'+e.diffPrevPax.toFixed(3)+"</span></td></tr></table></div>";if(s.push(a),s.push("<div><table>"),t.runs.length>0)for(var n=0;n<t.runs.length;n++){var i=t.runs[n],r="",d="";i.cones>0&&(r=' <span style="color:red;">+'+i.cones+"</span>"),i.isDnf?d=" DNF":i.getsRerun?d=" RERUN":i.isOff&&(d=" OFF");var l="";""!=d?l=d:(l=i.rawTime.toFixed(3),i.cones>0&&(l+=' <span style="color:red;"> +'+i.cones+"</span>")),s.push('<tr><td style="color:gray;padding-right:12px;">'+(n+1)+"</td><td>"+l+"</td></tr>")}else s.push("<tr><td>No Runs</td></tr>");s.push('</table></div><div style="clear:both;"></div>'),s.push("</div>"),$("#popuppartdata").html(s.join(""))}}})}function nextUpblock(t){var e=[];e.push('<div style="float:left;margin-right:18px;">'),e.push('<div style="font-size:1.5em;font-weight:bold">'+t.driver.name+"</div>"),e.push("<div><strong>"+t.axClass.name+" #"+t.driver.carNumber+"</strong></div>"),e.push("<div>"+t.driver.car.description+"</div>"),e.push("<p></p>");var s=t.axClass.name;t.axClass.paxClass.length>0&&(s=t.axClass.paxClass),$.ajax({url:"/api/driverinfo/"+eventId,dataType:"json",data:{axclass:t.axClass.name,carnum:t.driver.carNumber,participantId:t.participantId},success:function(t){if("success"==t.status){var a=t.participant,n='<table width="100%"><tr><td style="color:gray;">Overall: </td><td><strong>'+getRank(a.rankOverall)+"</strong></td><td><span>+"+a.diffOverall.toFixed(3)+'</span> <span style="font-size:.8em;">+'+a.diffPrevOverall.toFixed(3)+'</span></td></tr><tr><td style="color:gray;">Class: </td><td><strong>'+getRank(a.rankClass)+"</strong></td><td><span>+"+a.diffClass.toFixed(3)+'</span> <span style="font-size:.8em;">+'+a.diffPrevClass.toFixed(3)+'</span></td></tr><tr><td style="color:gray;">PAX: </td><td><strong>'+getRank(a.rankPax)+"</strong></td><td><span>+"+a.diffPax.toFixed(3)+'</span> <span style="font-size:.8em;">+'+a.diffPrevPax.toFixed(3)+"</span></td></tr></table></div>";if(e.push(n),e.push("<div><table>"),t.runs.length>0)for(var i=0;i<t.runs.length;i++){var r=t.runs[i],d="",l="";r.cones>0&&(d=' <span style="color:red;">+'+r.cones+"</span>"),r.isDnf?l=" DNF":r.getsRerun?l=" RERUN":r.isOff&&(l=" OFF");var o="";""!=l?o=l:(o=r.rawTime.toFixed(3),r.cones>0&&(o+=' <span style="color:red;"> +'+r.cones+"</span>")),e.push('<tr><td style="color:gray;padding-right:12px;">'+(i+1)+"</td><td>"+o+"</td></tr>")}else e.push("<tr><td>No Runs</td></tr>");e.push("</table></div>"),e.push("</div>"),$("#nextUpblock").html(e.join("")),$("#nextUpParts").html(getClassRankings(s,a.participantId))}}})}function doNextup(t){var e='<div id="nextup-'+t._id+'"><h3 style="margin-top:0;margin-bottom:4px;">'+t.driver.name+" #"+t.driver.carNumber+"</h3>"+t.driver.car.description+"<br/>"+t.axClass.name+"</div>";$("#nextup").html(e),$("#nextup-details").empty(),$("#nextup-runs").empty(),$.ajax({url:"/api/driverinfo/"+eventId,dataType:"json",data:{axclass:t.axClass.name,carnum:t.driver.carNumber,partId:t.participantId},success:function(t){var e=[];if("success"==t.status)if(t.runs.length>0){e.push('<table width="100%"><tr style="font-weight:bold;"><td>Run #</td><td>Time</td><td>Cones</td><td></td></tr>');for(var s=0;s<t.runs.length;s++){var a=t.runs[s],n="",i="";a.cones>0&&(n=' <span style="color:red;">+'+a.cones+"</span>"),a.isDnf?i=" DNF":a.getsRerun?i=" RERUN":a.isOff&&(i=" OFF"),e.push("<tr><td>"+(s+1)+"</td><td>"+a.rawTime.toFixed(3)+"</td><td>"+n+"</td><td>"+i+"</td></tr>")}var r=t.participant,d="<table><tr><td>Overall: </td><td>"+(0==r.rankOverall?"-":"#"+r.rankOverall)+"</td></tr><tr><td> Class: </td><td>"+(0==r.rankClass?"-":"#"+r.rankClass)+"</td></tr><tr><td> PAX: </td><td>"+(0==r.rankPax?"-":"#"+r.rankPax)+"</td></tr></table>";$("#nextup-details").html(d),$("#nextup-runs").html(e.join("")+"</table>")}else $("#nextup-runs").html("This will be their first run.")}})}function doJustFinished(t){function e(){$.ajax({url:"/api/announcer/"+t._id,dataType:"json",success:function(e){t.axClass.paxClass.length>0?t.axClass.paxClass:t.axClass.name;if("success"==e.status){participants=e.participants,setClasses(),doClasses(),regenTtod(),queue.length>0&&$("#nextUpParts").html(getClassRankings(queue[0].axClass.paxClass.length>0?queue[0].axClass.paxClass:queue[0].axClass.name,queue[0].participantId));for(var s=getClassRankings(t.axClass.paxClass.length>0?t.axClass.paxClass:t.axClass.name,t.participantId),a=null,n=0;n<e.participants.length;n++){var i=e.participants[n];if(i._id==t.participantId){d=i.bestTime==t.totalTime,a=i;break}}if(d){for(var r=999999,l=0,n=0;n<e.runs.length;n++){var o=e.runs[n];o.isDnf||o.isOff||o.getsRerun||o.totalTime<r&&o.totalTime!=a.bestTime&&(r=o.totalTime)}999999!=r&&(l=a.bestTime-r,$("#driverbest").text("DRIVER's BEST by "+l.toFixed(3)))}$("#justfinished-class").html(s),$("#driversruns").html(getRunsHtml(e.runs)),refreshParticipantClick()}else alert("There was an error. "+e.message)}})}var s=[];s.push('<div style="float:left;margin-right:18px;">'),s.push('<div style="font-size:1.5em;font-weight:bold">'+t.driver.name+"</div>"),s.push("<div><strong>"+t.axClass.name+" #"+t.driver.carNumber+"</strong></div>"),s.push("<div>"+t.driver.car.description+"</div>"),s.push("<p></p>"),s.push("</div>"),s.push("<div>");var a=t.rawTime.toFixed(3),n=t.paxTime.toFixed(3),i=t.totalTime.toFixed(3);if(t.cones>0&&(a=a+' <span style="color:red;">+'+t.cones+"</span>"),t.isDnf?(a="DNF",n="",i=""):t.getsRerun?(a="RERUN",n="",i=""):t.isOff?(a="OFF",n="",i=""):(n="indexed: "+n,i="total: "+i),s.push('<div><div style="font-size:3em;font-weight:bold;">'+a+'</div><div style="font-size:.9em;"><div>'+n+"</div><div>"+i+"</div></div></div>"),t.coneHits.length>0){s.push("<div><strong>Cone Hits</strong><table>");for(var r=0;r<t.coneHits.length;r++)s.push("<tr><td>Station: "+t.coneHits[r].station+"</td><td>+"+t.coneHits[r].cones+"</td></tr>");s.push("</table></div>")}s.push('<div id="driverbest" style="margin-top:12px;color:green;font-size:1.8em;font-weight:bold;"></div><div id="driversruns" style="margin-top:18px;"></div></div>'),$("#justfinished").html(s.join(""));var d=!1;setTimeout(e,350)}function getRunsHtml(t){var e="<table>";if(0==t.length)e="No Runs";else{for(var s=0;s<t.length;s++){var a=t[s];if(e+='<tr><td style="color:gray;padding-right:12px;">'+a.driverRunNumber+"</td><td>",a.isDnf)e+="DNF";else if(a.getsRerun)e+="RERUN";else if(a.isOff)e+="OFF";else{var n=a.rawTime.toFixed(3);a.cones>0&&(n+=" +"+a.cones),e+=n}e+="</td></tr>"}e+="</table>"}return e}function doJustFinishedOLD(t){function e(){$.ajax({url:"/api/announcer/"+t._id,dataType:"json",success:function(e){var s=[],a=t.axClass.paxClass.length>0?t.axClass.paxClass:t.axClass.name;if("success"==e.status){s.push('<table width="49%"><tr style="font-weight:bold;"><td>Rank</td><td>Driver</td><td>#</td><td>Car</td><td>Best</td><td>Diff 1st</td><td>Diff Prev.</td></tr>');var n=9999.999,r=9999.999;participants=e.participants,setClasses(),doClasses(),queue.length>0&&$("#nextUpParts").html(getClassRankings(queue[0].axClass.paxClass.length>0?queue[0].axClass.paxClass:queue[0].axClass.name,queue[0].participantId));for(var d=0;d<e.participants.length;d++){var l=e.participants[d],o=l.axClass.paxClass.length>0?l.axClass.paxClass:l.axClass.name;if(l.rankClass>0&&a==o){1==l.rankClass&&(n=l.bestTime);var p=Math.round(1e3*(l.bestTime-n))/1e3,u=Math.round(1e3*(l.bestTime-r))/1e3,c="";l._id==t.participantId&&(c=' style="font-weight:bold;color:blue;"',i=l.bestTime==t.totalTime),s.push("<tr"+c+"><td>"+l.rankClass+"</td><td>"+l.driver.name+"</td><td>"+l.driver.carNumber+"</td><td>"+l.driver.car.description+"</td><td>"+l.bestTime.toFixed(3)+"</td><td>"+(p>0?"+"+p:" - ")+"</td><td>"+(u>0?"+"+u:" - ")+"</td></tr>"),r=l.bestTime}}s.push("</table>"),i&&$("#driverbest").text("DRIVER's BEST TIME!!"),$("#justfinished-class").html(s.join("")),refreshParticipantClick()}else alert("There was an error. "+e.message)}})}var s="";t.cones>0&&(s='<span style="color:red">+'+t.cones+"</span>");var a=t.isDnf?"DNF":t.getsRerun?"RERUN":t.isOff?"OFF":"",n='<table width="100%"><tr style="font-weight:bold;"><td>Driver</td><td>#</td><td>Car</td><td>Class</td><td>Time</td><td>Pen.</td></tr><tr><td>'+t.driver.name+"</td><td>"+t.driver.carNumber+"</td><td>"+t.driver.car.description+"</td><td>"+t.axClass.name+"</td><td>"+t.rawTime.toFixed(3)+" "+s+"</td><td>"+a+'</td></tr></table><div id="driverbest" style="height:22px;"></div>';$("#justfinished").html(n);var i=!1;setTimeout(e,350)}var queue=[],runs=[],participants=[],socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"queue",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("initq",function(t){queue=t;$("#an-queue").empty();if(t.length>0){var e=t[0];nextUpblock(e),updateInQueue()}else $("#inqeue").html('<div style="float:left;font-size:1.6em;font-weight:bold;"> Next to Finish:</div><div style="float:left;margin-left:20px;">No One</div>')}),socket.on("addq",function(t){console.log("addq"),queue.push(t.run),1==queue.length&&nextUpblock(t.run),updateInQueue()}),socket.on("delq",function(t){console.log("delq");for(var e=[],s=0;s<queue.length;s++)queue[s]._id.toString()!=t&&e.push(queue[s]);queue=e,queue.sort(function(t,e){return t.runNumber>e.runNumber?1:-1}),queue.length>0?nextUpblock(queue[0]):$("#nextUpblock").html("No one right now."),updateInQueue()});var classList=[];socket.on("initr",function(t){$("#an-run").empty();if(t.length>0){var e=t[0];doJustFinished(e)}else $("#an-run").append("<li><h3>None</h3></li>");$("#an-run").listview("refresh")}),socket.on("addr",function(t){doJustFinished(t)});