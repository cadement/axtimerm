function showEditRun(){var e=selectedQueue;$("#editrun-name").html(selectedQueue.driver.carNumber+" - "+selectedQueue.driver.name),ercones=e.cones,e.cones>0&&$("#er-cones").text(" +"+e.cones),e.rawTime>0&&$("#er-time").html("&nbsp;"+e.rawTime),ertime=" "+e.rawTime;var n="none";selectedQueue.isDnf?n="dnf":selectedQueue.getsRerun?n="rerun":selectedQueue.isOff&&(n="off"),$("#radio-pen-"+n).prop("checked",!0),$.mobile.changePage("#page-editrun",{role:"dialog"}),$('input[name="radio-pen"]').checkboxradio("refresh")}function addToQueueList(e,n){$("#ql-none").remove();var t="",i=showClassInNumber?e.axClass.name+" "+e.driver.carNumber:e.driver.carNumber;e.isDnf?t="DNF":e.isOff?t="OFF":e.getsRerun?t="RERUN":e.cones>0&&(t="+"+e.cones);var r="",a="";void 0!=e.runGroup&&(r=e.runGroup.color,a=e.runGroup.label);var s=$("#queuelist"),u=$('<li id="run-'+e._id+'"><a><div class="carnumber light">'+i+'</div><p class="list-rungroup conecount" style="background-color:'+r+'">'+(a||"&nbsp;")+"</p><h3>"+e.driver.name+' <span id="pen-'+e._id+'" class="pen">'+t+"</span></h3><p>"+e.driver.car.description+'</p><span class="ui-li-count">'+e.driverRunNumber+"</span></a></li>").data("run",e).bind("click",function(){selectedQueue=$(this).data("run"),showEditRun()});s.append(u);var o=s.children();o.sort(function(e,n){return $(e).data("run").runNumber>$(n).data("run").runNumber?-1*queueOrdering:queueOrdering}),s.append(o)}function addToRunList(e,n){var t="",i=showClassInNumber?e.axClass.name+" "+e.driver.carNumber:e.driver.carNumber;e.isDnf?t="DNF":e.isOff?t="OFF":e.getsRerun&&(t="RERUN");var r="",a="";void 0!=e.runGroup&&(r=e.runGroup.color,a=e.runGroup.label);var s=null==e.rawTime?"-":e.rawTime.toFixed(3),u=$('<li id="run-'+e._id+'"><a href="#popup-trouble2" data-rel="popup" data-position-to="window" id="runid-'+e.id+'" class="act-run"><div class="carnumber">'+i+'</div><div class="list-rungroup conecount" style="background-color:'+r+'">'+(a||"&nbsp;")+"</div><h3>"+e.driver.name+' <span id="pen-'+e._id+'" class="pen">'+t+'</span></h3><p class="ui-li-desc" style="font-size:1.2em;">'+s+' <span class="cones">'+(e.cones>0?"+"+e.cones:"")+'</span></p><span class="ui-li-count">'+e.driverRunNumber+"</span></a></li>").data("run",e).bind("click",function(){var e=$(this);e.attr("id").split("-")[1];selectedQueue=e.data("run"),isEdit=!0,$.mobile.changePage("#popup-trouble2",{role:"dialog"}),$("#options-desc").html('<hgroup class="driver"><h2>#'+selectedQueue.driver.carNumber+" "+selectedQueue.axClass.name+" - "+selectedQueue.driver.name+"</h2><h3>"+selectedQueue.driver.car.color+" "+selectedQueue.driver.car.description+"</h3></hgroup><h3>"+selectedQueue.rawTime+" "+(selectedQueue.cones>0?'<span class="cones">+'+selectedQueue.cones:"")+"</span>"+(selectedQueue.isDnf?" <span>DNF</span>":selectedQueue.getsRerun?"<span>RERUN</span>":selectedQueue.isOff?"<span>OFF</span>":"")+"</h3>")}),o=$('#runlist li[id="run-'+e._id+'"]');o.length>0?o.replaceWith(u):n?$("#runlist").append(u):$("#runlist").prepend(u)}function delQueueItem(e){$("#queuelist li#run-"+e).remove()}function delRunItem(e){$("#runlist li#run-"+e).remove()}function updateBatteryLevels(e){if(e.A&&e.B&&e.Z){var n='<img src="/css/images/battery_2.png" height="12"/> A: '+10*e.A+"% B: "+10*e.B+"% Z: "+10*e.Z+"%";$("#battery-levels").html(n)}}function showAllRuns(){$.ajax();$("#runlist").empty();if(runs=data,data.length>0)for(var e=0;e<data.length;e++){var n=data[e];addToRunList(n,!0)}else $("#runlist").append('<li id="run-none"><h3>None</h3></li>');$("#runlist").listview("refresh")}function addParticipant(e){var n=[];n.push('<li id="part-'+e._id.toString()+'" data-filtertext="'+e.driver.carNumber+" "+e.driver.name+" "+e.axClass.name+'">'),n.push('<a id="driver-'+e.memberId+"-"+e._id+'">'),n.push('<p class="list-rungroup" style="background-color:'+e.runGroup.color+'">'+(e.runGroup.label?" ("+e.runGroup.label+")":"&nbsp;")+"</p>"),n.push("<h3>"+e.driver.name+" #"+e.driver.carNumber+"</h3>"),n.push("<p><strong>"+e.axClass.name+"</strong></p>"),n.push("<p>"+e.driver.car.description+"</p>"),n.push('<span class="ui-li-count">'+e.totalCountedRuns+"</span>"),n.push("</a>"),n.push("</li>");var t=$("#part-"+e._id.toString()),i=$(n.join(""));i.find("a").bind("click",addPartClick),0==t.length?$("#drivers").append(i):t.replaceWith(i);try{$("#drivers").listview("refresh")}catch(r){}}function addPartClick(){var e=$(this).attr("id").split("-")[2];socket.emit("addq",{carNumber:"",participantId:e,position:-1}),$(".ui-dialog").dialog("close")}function saveRun(){var e=$('input[name="radio-pen"]:checked').val(),n={rid:selectedQueue._id,time:parseFloat(ertime),cones:ercones,dnf:"dnf"==e,off:"off"==e,rerun:"rerun"==e};socket.emit("finq",n),"Q"==selectedQueue.status?selectedQueue=null:(selectedQueue.rawTime=parseFloat(ertime),selectedQueue.cones=ercones,selectedQueue.isDnf="dnf"==e,selectedQueue.isOff="off"==e,selectedQueue.getsRerun="rerun"==e),$(".ui-dialog").dialog("close")}function adjustCones(e){var n="";"add"==e?(ercones++,n=" +"+ercones):2>ercones?(ercones=0,n=""):(ercones--,n=" +"+ercones),$("#er-cones").text(n)}function updateTime(e){"clr"==e.toLowerCase()?($("#er-time").html("&nbsp;"),ertime=""):"del"==e.toLowerCase()||"<"==e.toLowerCase()?(ertime=ertime.length<2?"":ertime.toString().substr(0,ertime.length-1),$("#er-time").html(0==ertime.length?"&nbsp;":ertime)):". "==e?-1==ertime.indexOf(".")&&(ertime+=".",$("#er-time").text(ertime)):(ertime=$("#er-time").text(),ertime+=e+"",$("#er-time").text(ertime))}function changeRunResult(e){$("#radio-pen-"+e).prop("checked",!0),$('input[name="radio-pen"]').checkboxradio("refresh")}function enableKeypress(){$(document).bind("keydown",function(e){var n=String.fromCharCode(e.which);if(console.log("character: "+n+", which:"+e.which),"base"==currentPage);else if("addcar"==currentPage);else if("editrun"==currentPage){var t=null;8==e.which?(e.preventDefault(),t="del"):13==e.which?saveRun():e.which>=48&&e.which<58?t=n:e.which>=96&&e.which<106?t=(e.which-96).toString():46===e.which?t="clr":187==e.which||"c"==n.toLowerCase()?adjustCones("add"):189==e.which||"v"==n.toLowerCase()?adjustCones("subtract"):190===e.which||110===e.which?t=". ":"d"==n.toLowerCase()?changeRunResult("dnf"):"n"==n.toLowerCase()?changeRunResult("none"):"o"==n.toLowerCase()?changeRunResult("off"):"r"==n.toLowerCase()&&changeRunResult("rerun"),null!=t&&updateTime(t)}})}function disableKeypress(){$("#page-editrun").unbind("keypress")}var isEdit=!1,runs=[],showClassInNumber=!0,queueOrdering=-1,participants=[],addParticipantShown=!1,currentPage="base",socket=io.connect("http://"+window.location.host);socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("message",function(e){$('<div class="msg-message ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><h1>Message</h1><p>'+e.message+"</p><p><a onclick=\"$('.msg-message').remove();\">Close</a></div>").css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)});var queue=[],runs=[],selectedQueue=null,ercones=0,ertime="";socket.on("initq",function(e){$("#queuelist").empty();if(e.length>0)for(var n=0;n<e.length;n++){var t=e[n];addToQueueList(t)}else $("#queuelist").append('<li id="ql-none"><h3>None</h3></li>');$("#queuelist").listview("refresh")}),socket.on("initr",function(e){$("#runlist").empty();if(runs=e,e.length>0)for(var n=0;n<e.length;n++){var t=e[n];addToRunList(t,!0)}else $("#runlist").append('<li id="run-none"><h3>None</h3></li>');$("#runlist").listview("refresh")}),socket.on("oncourse",function(e){for(var n="",t=0;t<e.length;t++)n+=e[t].driver.name+", ";alert("On course: "+n)}),socket.on("delq",function(e){delQueueItem(e),0==$("#queuelist li").length&&($("#queuelist").append('<li id="ql-none"><h3>None</h3></li>'),$("#queuelist").listview("refresh"))}),socket.on("delr",function(e){delRunItem(e),0==$("#runlist li").length&&($("#runlist").append('<li id="run-none"><h3>None</h3></li>'),$("#runlist").listview("refresh"))}),socket.on("addq",function(e){addToQueueList(e.run),$("#queuelist").listview("refresh")}),socket.on("addr",function(e){$("#run-none").remove(),addToRunList(e),runs.push(e),$("#runlist").listview("refresh")}),socket.on("cones",function(e){var n=$("#run-"+e.rid);$("#run-"+e.rid).data("run").cones=e.total,n.find("p.conecount").html(e.total),"page-editrun"==$.mobile.activePage.attr("id")&&$("#er-cones").text("+"+e.total)}),conesAdvancedMode&&socket.on("conesadv",function(e){var n=$("#run-"+e.rid),t=n.data("run");t.coneHits=e.coneHits,t.cones=e.total,t.isDnf=t.isOff=t.getsRerun=!1;var i="";e.total>0&&(i="+"+e.total),"dnf"==e.penalty&&(t.isDnf=!0,i="DNF"),"off"==e.penalty&&(t.isOff=!0,i="OFF"),"rerun"==e.penalty&&(t.getsRerun=!0,i="RERUN"),"none"==e.penalty||""==e.penalty,$("#pen-"+e.rid).text(i),n.data("run",t)}),socket.on("battery",function(e){updateBatteryLevels(e)}),socket.on("adminmsg",function(e){var n=$(".alert").show();n.find("span").text(e)}),$(".alert > a").on("click",function(){$(this).parent().hide()}),socket.on("initreg",function(e){}),socket.on("regchange",function(e){"add"==e.action||"update"==e.action?addParticipant(e.data):"delete"==e.action&&$("#part-"+e.data).remove()});var search="",lastval="",dialogVisible=!1;$(document).bind("pageinit",function(){$.ajax({url:"/api/hardware/batterylevels",type:"GET",dataType:"json",success:function(e){updateBatteryLevels(e)}})}),$("#page-addcar").bind("pagehide",function(e,n){dialogVisible=!1,$('#page-addcar input[data-type="search"]').val(""),$('#page-addcar input[data-type="search"]').trigger("keyup"),search="",lastval="",currentPage="base"}),$("#page-addcar").bind("pageshow",function(){addParticipantShown=!0,dialogVisible=!0,currentPage="addcar"}),$("#page-editrun").bind("pagehide",function(){$("#er-cones").text(""),$("#er-time").text(""),ercones=0,ertime="",isEdit=!1}),$("#btn-showeditrun").bind("click",function(){showEditRun()}),$(".btn-options").bind("click",function(){var e=$(this).attr("id").split("-")[1];null==selectedQueue?alert("No run selected."):"showparticipant"==e&&(document.location.href="/participant/"+selectedQueue.participantId)}),$(".parts").bind("click",function(){var e=$(this).attr("id").split("-")[1];socket.emit("runswapdriver",{runId:selectedQueue._id,participantId:e}),selectedQueue=null}),$(".btn-trouble").bind("click",function(){var e=$(this).attr("id").split("-")[2];if("deldriverkeeptimes"==e)"F"==selectedQueue.status?(socket.emit("deleterunkeeptimes",selectedQueue._id),selectedQueue=null,$(".ui-dialog").dialog("close")):alert("A run in the queue cannot be used.");else if("changetimemoveup"==e){var n=0;try{n=parseFloat($("#tb-trouble-time").val()),n>0?(socket.emit("changetimemoveup",{runId:selectedQueue._id,newTime:n}),$(".ui-dialog").dialog("close"),$("#tb-trouble-time").val(""),selectedQueue=null):alert("Invalid Time")}catch(t){alert("invalid time")}}else if("swapdriver"==e){var i=$("#ddl-trouble-driver").val();socket.emit("runswapdriver",{runId:selectedQueue._id,participantId:i}),$(".ui-dialog").dialog("close"),selectedQueue=null}}),$("#btn-save-session").click(function(){var e=$("input:radio[name=radio-session]:checked").val(),n=$("input:radio[name=radio-rg]:checked").val(),t=$("input:radio[name=radio-rg]:checked").parent().find(".ui-btn-text").text();$.ajax({url:"/api/event/changesession/"+eventId,type:"POST",dataType:"json",data:{session:e,runGroup:n},success:function(i){"success"==i.status?($("#lbl-session").text(e),$("#lbl-rg").css("background-color",n).text(t)):alert(i.message)}})}),$("#btn-addback").click(function(){console.log("add back click"),socket.emit("backr",{rid:selectedQueue._id})}),$("#page-editrun").bind("pageshow",function(){currentPage="editrun"}),$("#page-editrun").bind("pagehide",function(){currentPage="base"}),$("#popup-trouble2").bind("pageshow",function(){currentPage="options"}),$("#popup-trouble2").bind("pagehide",function(){currentPage="base"}),$("#drivers a").bind("click",addPartClick),$("#page-editrun .btn-cancel").bind("click",function(){$(".ui-dialog").dialog("close")}),$("#page-editrun .btn-save").bind("click",function(){saveRun()}),$(".btn-delete").bind("click",function(){var e=($(this),"F"==selectedQueue.status?"delr":"delq");socket.emit(e,selectedQueue._id),selectedQueue=null,$(".ui-dialog").dialog("close")}),$("#page-editrun .btn-deletedriver").bind("click",function(){$(this);console.log("doing deletedriver"),"F"==selectedQueue.status&&(socket.emit("deleterunkeeptimes",selectedQueue._id),selectedQueue=null,$(".ui-dialog").dialog("close"))}),$("#page-editrun .btn-cones").bind("vclick",function(){adjustCones($(this).hasClass("add")?"add":"subtract")}),$("#page-editrun .btn-number").bind("vclick",function(){var e=$(this).text();updateTime(e)}),$("#page-addcar .btn-number").bind("vclick",function(){var e=$(this).text();"clr"==e.toLowerCase()?search="":"del"==e.toLowerCase()?search=search.substr(0,search.length-1):search+=e.toString(),$('#page-addcar input[data-type="search"]').val(search),$('#page-addcar input[data-type="search"]').trigger("keyup")}),$(".btn-resethardware").on("click",function(){var e=$(this).data("reset");["start","finish","full"].indexOf(e)>-1&&$.ajax({url:"/api/hardware/reset"+e,type:"POST",success:function(e){e.success||alert("Error: "+e.message)},error:function(e,n,t){alert("There was a problem talking to the server. "+n)}})}),enableKeypress();