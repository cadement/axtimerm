function genRow(e,n,t){return'<div id="'+e+'" class="timer-row group '+n+'" runid=""><div class="gutter"><div class="wrapper"><span>&nbsp;</span></div></div><div class="time"><span>0.000</span></div><div class="splits"><span>&nbsp;</span></div><div class="penalty"><span>&nbsp;</span></div><div class="driver"><div class="wrapper"><div class="clsnum"><span>&nbsp;</span></div><div class="car"><span>&nbsp;</span></div><div class="name"><span>&nbsp;</span></div></div></div></div>'}function doQueue(){for(var e=starts.length,n=(queue.length,0);4>n;n++)e>n?updateBox("timer-"+n,queue[n],!1):updateBox("timer-"+n,null,!0);updateBox("queue-0",queue[e])}function updateRuns(){var e=runs[0];if(void 0!==e){updateBox("run-0",e,!0);var n=runs[1];void 0!==n&&updateBox("run-1",n,!0)}}function updateBox(e,n,t){var r=$("#"+e),s="0.000",i="&nbsp;",u="&nbsp;",o="&nbsp;",a="",d="",c="&nbsp;";n&&(s="F"==n.status?n.rawTime.toFixed(3):"0.000",i="#"+n.driver.carNumber+" "+n.axClass.name,u=n.driver.car.description,o=n.driver.name,a=n.isDnf?"DNF":n.getsRerun?"RRN":n.isOff?"OFF":"",""==a&&n.cones>0&&(a="+"+n.cones),d=n._id,c=n.runNumber),t&&r.find(".time span").html(s),r.find(".gutter span").html(c),r.attr("runid",d),r.find(".clsnum span").html(i),r.find(".car span").html(u),r.find(".name span").html(o),r.find(".penalty span").html(""==a?"&nbsp;":a)}function startTimers(){timerId=setInterval(updateTimers,63),timerRunning=!0}function stopTimers(){null!==timerId&&(clearInterval(timerId),timerRunning=!1),timerId=null}function updateTimers(){for(var e=0;e<starts.length;e++)timerEls[e].text(calcTime(e))}function calcTime(e){var n=starts[e];if(void 0!==n){var t=serverStamp-localStamp,r=(new Date).getTime()+t-n;return(r/1e3).toFixed(3)}return"-"}var queue=[],runs=[],starts=[],serverStamp=(new Date).getTime(),localStamp=(new Date).getTime(),timerId=null;$("#btn-theme").on("click",function(){$("#chrono-timers").toggleClass("dark")}),$("#chrono-timers").append(genRow("queue-0","queue"));for(var i=3;i>-1;i--){var bg="light";i%2==0&&(bg="dark");var html=genRow("timer-"+i,bg);$("#chrono-timers").append(html)}$("#chrono-timers").append(genRow("run-0","run justfinished")),$("#chrono-timers").append(genRow("run-1","run"));var socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"queue",eventId:eventId}),socket.emit("join",{stream:"chrono",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("message",function(e){$('<div class="msg-message ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><h1>Message</h1><p>'+e.message+"</p><p><a onclick=\"$('.msg-message').remove();\">Close</a></div>").css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)});var timerRunning=!1;socket.on("chrono",function(e){if(starts=e.starts,splits=e.splits,serverStamp=e.timestamp,localStamp=(new Date).getTime(),starts.length>0){timerRunning||startTimers();for(var n=3;n>starts.length;n--)timerEls[n].text("0.000")}else stopTimers();doQueue()}),socket.on("initq",function(e){queue=e,queue.sort(function(e,n){return e.runNumber<n.runNumber?-1:1}),doQueue()}),socket.on("addq",function(e){queue.push(e.run),queue.sort(function(e,n){return e.runNumber<n.runNumber?-1:1}),doQueue()}),socket.on("delq",function(e){for(var n=[],t=0;t<queue.length;t++)queue[t]._id.toString()!=e&&n.push(queue[t]);queue=n,queue.sort(function(e,n){return e.runNumber>n.runNumber?1:-1}),doQueue()}),socket.on("initr",function(e){runs=e,runs.sort(function(e,n){return e.runNumber>n.runNumber?-1:1}),updateBox("run-0",runs[0],!0),updateBox("run-1",runs[1],!0)}),socket.on("addr",function(e){for(var n=!1,t=0;t<runs.length;t++)runs[t]._id==e._id&&(runs[t]=e,n=!0);n||runs.unshift(e),updateRuns()}),socket.on("delr",function(e){for(var n=[],t=0;t<runs.length;t++)runs[t]._id!=e&&n.push(runs[t]);runs=n,updateRuns()}),socket.on("conesadv",function(e){var n="";["off","dnf","rerun"].indexOf(e.penalty)>-1&&(n=e.penalty.toUpperCase()),"RERUN"==n?n="RRN":""==n&&e.total>0&&(n="+"+e.total),$('div[runid="'+e.rid+'"] .penalty span').fadeOut(750,function(){$(this).html(""==n?"&nbsp;":n).fadeIn(1500)});for(var t=!1,r=0;r<queue.length;r++)if(queue[r]._id==e.rid){queue[r].cones=e.total,queue[r].isDnf="dnf"==e.penalty,queue[r].isOff="off"==e.penalty,queue[r].getsRerun="rerun"==e.penalty,queue[r].coneHits=e.coneHits,t=!0;break}if(!t)for(var r=0;r<runs.length;r++)if(runs[r]._id==e.rid){runs[r].cones=e.total,runs[r].isDnf="dnf"==e.penalty,runs[r].isOff="off"==e.penalty,runs[r].getsRerun="rerun"==e.penalty,runs[r].coneHits=e.coneHits;break}});var timerEls=[$("#timer-0 .time span"),$("#timer-1 .time span"),$("#timer-2 .time span"),$("#timer-3 .time span")];