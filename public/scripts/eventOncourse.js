function genRow(e,t){var n=[],r=void 0===starts[t]?"-":((serverStamp-starts[t])/1e3).toFixed(3),s=void 0===splits[t]?"-":splits[t].toFixed(3),i="",u="",o="",a="",c=t;return e&&(i=e.driver.name,u=e.axClass.name+" #"+e.driver.carNumber,o=e.driver.car.description,c=e._id,e.isOff?a="OFF":e.isDnf?a="DNF":e.getsRerun?a="RERUN":e.cones>0&&(a=e.cones)),n.push('<tr id="run-'+c+'"><td class="alignRight"><span class="oc-cartime" id="timer-'+t+'">'+r+'</span></td><td class="alignRight">'+s+'</td><td class="alignCenter cones">'+a+'</td><td></td><td class="driver">'+i+"</td><td>"+u+"</td><td>"+o+"</td></tr>"),n.join("")}function startTimers(){timerId=setInterval(updateTimers,111),timerRunning=!0}function stopTimers(){clearInterval(timerId),timerRunning=!1}function updateTimers(){for(var e=0;e<starts.length;e++)$("#timer-"+e).html(calcTime(e))}function calcTime(e){var t=starts[e];if(void 0!==t){var n=serverStamp-t,r=(new Date).getTime()-localStamp;return((n+r)/1e3).toFixed(3)}return"-"}function gen(e){updateQueue();for(var t=[],n=((new Date).getTime(),0);n<starts.length;n++){var r=queue[n];void 0!==r?t.push(genRow(r,n)):t.push(genRow(null,n))}0==starts.length&&t.push('<tr><td colspan="6">No timers are active.</td></tr>'),$("table.oncourse tbody").html(t.join(""))}function updateQueue(){for(var e="",t=starts.length;t<queue.length;t++){var n=queue[t];e+="<p><b>"+n.axClass.name+" #"+n.driver.carNumber+"</b><br/>"+n.driver.car.description+"<br/>"+n.driver.name+"</p>"}0==queue.length&&(e="<p>No drivers in queue</p>"),$("#queue").html(e)}function updateRuns(){var e=[];console.log("update runs");for(var t=0;3>t;t++){var n=runs[t];e.push(genRun(n))}$("table.recentruns tbody").html(e.join(""))}function genRun(e){var t=[],n=e.totalTime>0?e.totalTime.toFixed(3):"-",r=[];if(e.splitTimes.length>0&&null!=e.splitTimes[0])for(var s=0;s<e.splitTimes.length;s++)r.push(e.splitTimes[s].toFixed(3));var i="",u="",o="",a="",c=e._id;return e&&(i=e.driver.name,u=e.axClass.name+" #"+e.driver.carNumber,o=e.driver.car.description,e.cones>0&&(a=e.cones.toString())),t.push('<tr id="run-'+c+'"><td class="alignRight"><span class="oc-cartime">'+n+'</span></td><td class="alignRight">'+r.join(", ")+'</td><td class="alignCenter cones">'+a+'</td><td></td><td class="driver">'+i+"</td><td>"+u+"</td><td>"+o+"</td></tr>"),t.join("")}var queue=[],runs=[],participants=[],socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"queue",eventId:eventId}),socket.emit("join",{stream:"chrono",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})});var starts=[],splits=[],queue=[],runs=[],timers=[],serverStamp=(new Date).getTime(),localStamp=(new Date).getTime(),timerRunning=!1,timerId=null;socket.on("chrono",function(e){starts=e.starts,splits=e.splits,serverStamp=e.timestamp,localStamp=(new Date).getTime(),starts.length>0?timerRunning||startTimers():stopTimers(),gen()}),socket.on("initq",function(e){e.sort(function(e,t){return e.runNumber<t.runNumber?-1:1}),queue=e,e.length>0,gen()}),socket.on("addq",function(e){queue.push(e.run),queue.sort(function(e,t){return e.runNumber<t.runNumber?-1:1}),gen()}),socket.on("delq",function(e){for(var t=[],n=0;n<queue.length;n++)queue[n]._id.toString()!=e&&t.push(queue[n]);queue=t,queue.sort(function(e,t){return e.runNumber>t.runNumber?1:-1}),gen()}),socket.on("addr",function(e){for(var t=!1,n=0;n<runs.length;n++)runs[n]._id==e._id&&(runs[n]=e,t=!0);t||runs.unshift(e),updateRuns()}),socket.on("initr",function(e){console.log("initr"),e.sort(function(e,t){return e.runNumber>t.runNumber?-1:1}),runs=e,updateRuns()}),socket.on("delr",function(e){console.log("delr");for(var t=[],n=0;n<runs.length;n++)runs[n]._id!=e&&t.push(runs[n]);runs=t,updateRuns()}),socket.on("conesadv",function(e){var t="";t=["off","dnf","rerun"].indexOf(e.penalty)>-1?e.penalty.toUpperCase():e.total,$("#run-"+e.rid+" .cones").html(t);for(var n=!1,r=0;r<queue.length;r++)if(queue[r]._id==e.rid){queue[r].cones=e.total,queue[r].isDnf="dnf"==e.penalty,queue[r].isOff="off"==e.penalty,queue[r].getsRerun="rerun"==e.penalty,queue[r].coneHits=e.coneHits,n=!0;break}if(!n)for(var r=0;r<runs.length;r++)if(runs[r]._id==e.rid){runs[r].cones=e.total,runs[r].isDnf="dnf"==e.penalty,runs[r].isOff="off"==e.penalty,runs[r].getsRerun="rerun"==e.penalty,runs[r].coneHits=e.coneHits;break}});