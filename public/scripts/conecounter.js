function addToQueueList(e,n){$("#ql-none").remove(),queueItems.push(e);var i="",t=null,a=showClassInNumber?e.axClass.name+" "+e.driver.carNumber:e.driver.carNumber;if(advancedMode){var o=e.isDnf?"(DNF)":e.getsRerun?"(RERUN)":e.isOff?"(OFF)":"";i='<li id="run-'+e._id+'"><a><div class="carnumber light">'+a+'</div><p class="list-conecount"><span>'+e.cones+"</span></p><h3>"+e.driver.name+' <span id="pen-'+e._id+'" class="pen">'+o+"</span></h3><p>"+e.driver.car.description+"</p></li></a></li>",t=$(i).data("run",e).bind("vclick",showCones)}else i='<li id="run-'+e._id+'"><div style="float:right;"><button class="btn-cc-add" data-role="button" data-rid="'+e._id+'" data-inline="true" data-theme="e">+1</button><button class="btn-cc-del" data-role="button" data-inline="true" data-theme="b" data-rid="'+e._id+'">-1</button></div><div class="carnumber light" style="right:40%">'+e.driver.carNumber+'</div><p class="list-conecount"><span>'+e.cones+"</span></p><h3>"+e.driver.name+"</h3><p>"+e.driver.car.description+"</p></li>",t=$(i).data("run",e);var r=$("#queuelist");r.append(t).trigger("create");var d=r.children();d.sort(function(e,n){return $(e).data("run").runNumber>$(n).data("run").runNumber?-1*queueOrdering:queueOrdering}),r.append(d)}function addToRunList(e,n){var i="",t=showClassInNumber?e.axClass.name+" "+e.driver.carNumber:e.driver.carNumber;e.isDnf?i="DNF":e.isOff?i="OFF":e.getsRerun&&(i="RERUN");var a="";if(advancedMode)a='<li id="run-'+e._id+'"><a><div class="carnumber">'+t+'</div><p class="list-conecount"><span>'+e.cones+"</span></p><h3>"+e.driver.name+' <span id="pen-'+e._id+'" class="pen">'+i+"</span></h3><p>"+e.driver.car.description+"</p></li></a></li>",o=$(a).data("run",e).bind("vclick",showCones);else{a='<li id="run-'+e._id+'"><div style="float:right;"><button class="btn-cc-add" data-role="button" data-rid="'+e._id+'" data-inline="true" data-theme="e">+1</button><button class="btn-cc-del" data-role="button" data-inline="true" data-theme="b" data-rid="'+e._id+'">-1</button></div><div class="carnumber" style="right:40%">'+e.driver.carNumber+'</div><p class="list-conecount"><span>'+e.cones+"</span></p><h3>"+e.driver.name+"</h3><p><strong>"+(null==e.rawTime?"":e.rawTime)+(""!=i?" ("+i+")":"")+'</strong></p><p style="font-size:.7em;">'+e.driver.car.description+"</p></li>";var o=$(a).data("run",e)}var r=$('#runlist li[id="run-'+e._id+'"]');r.length>0?(r.replaceWith(o),o.trigger("create")):n?$("#runlist").append(o).trigger("create"):$("#runlist").prepend(o).trigger("create"),$("#runlist").listview("refresh")}function delQueueItem(e){$("#queuelist li#run-"+e).remove();for(var n=[],i=0;i<queueItems.length;i++)queueItems[i]._id.toString()!=e&&n.push(queueItems[i]);queueItems=n}function delRunItem(e){$("#runlist li#run-"+e).remove()}function saveCones(){console.log("saving cones");var e=parseInt($('input[name="radio-cone"]:checked').val()),n=$('input[name="radio-station"]:checked').val(),i=$('input[name="radio-pen"]:checked').val();if(null!=selectedRun){var t={rid:selectedRun._id,cones:e,station:n,penalty:i,stream:"Q"==selectedRun.status?"queue":"runs"};socket.emit("conesadv",t)}$("#pnl-cones").slideUp("slow"),selectedRun=null}function showCones(){var e=$(this),n=e.data("run");e.attr("id").split("-")[1];$.mobile.changePage("#dlg-cones",{role:"dialog"});for(var i=[],t=0,a=0;a<n.coneHits.length;a++)i.push("Station #"+n.coneHits[a].station+" +"+n.coneHits[a].cones),0==n.coneHits[a].station&&(t=n.coneHits[a].cones);$("#pnl-stations").html(i.join(", ")),$("#lbl-driver").text("#"+n.driver.carNumber+" - "+n.driver.name),$("#radio-station-na").prop("checked",!0),$("input[name=radio-station]").checkboxradio("refresh"),$("#radio-cone-"+t).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh");var o=n.isDnf?"dnf":n.getsRerun?"rerun":n.isOff?"off":"none";$("#radio-pen-"+o).prop("checked",!0),$("input[name=radio-pen]").checkboxradio("refresh"),selectedRun=n}function hideConePanel(){selectedRun=null,$("#pnl-cones").hide()}function showConePanel(){for(var e=$(this),n=e.data("run"),i=e.attr("id").split("-")[1],t=$("#pnl-cones"),a=[],o=0,r=0;r<n.coneHits.length;r++)a.push("Station #"+n.coneHits[r].station+" +"+n.coneHits[r].cones),0==n.coneHits[r].station&&(o=n.coneHits[r].cones);if(1==t.length)if(null!=selectedRun&&i==selectedRun._id)t.hide(),selectedRun=null;else{$("#pnl-stations").html(a.join(", ")),$.mobile.changePage(t,{role:"dialog"}),$("#radio-station-na").prop("checked",!0),$("input[name=radio-station]").checkboxradio("refresh"),$("#radio-cone-"+o).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh");var d=n.isDnf?"dnf":n.getsRerun?"rerun":n.isOff?"off":"none";$("#radio-pen-"+d).prop("checked",!0),$("input[name=radio-pen]").checkboxradio("refresh"),selectedRun=n}else{for(var s='<p id="pnl-stations">'+a.join(", ")+'</p><fieldset data-role="controlgroup" data-type="horizontal"><legend> Station:</legend><input type="radio" name="radio-station" id="radio-station-na" value="na" checked="checked"/><label for="radio-station-na">n/a</label>',r=0;r<stations.length;r++)s+='<input type="radio" name="radio-station" id="radio-choice-h-'+stations[r]+'" value="'+stations[r]+'"/><label for="radio-choice-h-'+stations[r]+'">'+stations[r]+"</label>";s+="</fieldset>",s+='<fieldset data-role="controlgroup" data-type="horizontal"><legend> Cones Hit:</legend>';for(var r=0;8>r;r++){var c="";r==o&&(c=' checked="checked"'),s+='<input type="radio" name="radio-cone" id="radio-cone-'+r+'" value="'+r+'"'+c+'/><label for="radio-cone-'+r+'">'+r+"</label>"}s+="</fieldset>",s+='<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true"><legend> Result:</legend>',s+='<input type="radio" name="radio-pen" id="radio-pen-none" value="none" checked="checked"/><label for="radio-pen-none">None</label>',s+='<input type="radio" name="radio-pen" id="radio-pen-dnf" value="dnf" '+(n.isDnf?' checked="checked"':"")+'/><label for="radio-pen-dnf">DNF</label>',s+='<input type="radio" name="radio-pen" id="radio-pen-rerun" value="rerun"'+(n.getsRerun?' checked="checked"':"")+'/><label for="radio-pen-rerun">RERUN</label>',s+='<input type="radio" name="radio-pen" id="radio-pen-off" value="off"'+(n.isOff?' checked="checked"':"")+'/><label for="radio-pen-off">OFF</label>',s+="</fieldset>",s+='<div class="ui-grid-a"><div class="ui-block-a"><button id="btn-savecones" data-role="button" data-theme="b">Save</button></div>',s+='<div class="ui-block-b"><button id="btn-canelcones" data-rel="back" data-role="button" data-theme="a">Cancel</button></div></div>';var l=$('<div id="pnl-cones" data-role="dialog"></div>');l.append(s),l.find("#btn-savecones").bind("vclick",saveCones),$("input[name=radio-station]").click(function(){var e=$(this).val(),n=!1;"na"==e&&(e=0);for(var i=0;i<selectedRun.coneHits.length;i++)if(e==selectedRun.coneHits[i].station){$("#radio-cone-"+selectedRun.coneHits[i].cones).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh"),n=!0;break}n||($("#radio-cone-0").prop("checked","checked"),$("input[name=radio-cone]").checkboxradio("refresh"))}),selectedRun=n,l.appendTo("body"),$.mobile.changePage(l,{role:"dialog"})}}function showConePanel2(){for(var e=$(this),n=e.data("run"),i=e.attr("id").split("-")[1],t=$("#pnl-cones"),a=[],o=0,r=0;r<n.coneHits.length;r++)a.push("Station #"+n.coneHits[r].station+" +"+n.coneHits[r].cones),0==n.coneHits[r].station&&(o=n.coneHits[r].cones);if(1==t.length)if(null!=selectedRun&&i==selectedRun._id)t.hide(),selectedRun=null;else{$("#pnl-stations").html(a.join(", ")),t.insertAfter(e).show(),$("#radio-station-na").prop("checked",!0),$("input[name=radio-station]").checkboxradio("refresh"),$("#radio-cone-"+o).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh");var d=n.isDnf?"dnf":n.getsRerun?"rerun":n.isOff?"off":"none";$("#radio-pen-"+d).prop("checked",!0),$("input[name=radio-pen]").checkboxradio("refresh"),selectedRun=n}else{for(var s='<p id="pnl-stations">'+a.join(", ")+'</p><fieldset data-role="controlgroup" data-type="horizontal"><legend> Station:</legend><input type="radio" name="radio-station" id="radio-station-na" value="na" checked="checked"/><label for="radio-station-na">n/a</label>',r=0;r<stations.length;r++)s+='<input type="radio" name="radio-station" id="radio-choice-h-'+stations[r]+'" value="'+stations[r]+'"/><label for="radio-choice-h-'+stations[r]+'">'+stations[r]+"</label>";s+="</fieldset>",s+='<fieldset data-role="controlgroup" data-type="horizontal"><legend> Cones Hit:</legend>';for(var r=0;8>r;r++){var c="";r==o&&(c=' checked="checked"'),s+='<input type="radio" name="radio-cone" id="radio-cone-'+r+'" value="'+r+'"'+c+'/><label for="radio-cone-'+r+'">'+r+"</label>"}s+="</fieldset>",s+='<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true"><legend> Result:</legend>',s+='<input type="radio" name="radio-pen" id="radio-pen-none" value="none" checked="checked"/><label for="radio-pen-none">None</label>',s+='<input type="radio" name="radio-pen" id="radio-pen-dnf" value="dnf" '+(n.isDnf?' checked="checked"':"")+'/><label for="radio-pen-dnf">DNF</label>',s+='<input type="radio" name="radio-pen" id="radio-pen-rerun" value="rerun"'+(n.getsRerun?' checked="checked"':"")+'/><label for="radio-pen-rerun">RERUN</label>',s+='<input type="radio" name="radio-pen" id="radio-pen-off" value="off"'+(n.isOff?' checked="checked"':"")+'/><label for="radio-pen-off">OFF</label>',s+="</fieldset>",s+='<div class="ui-grid-a"><div class="ui-block-a"><button id="btn-savecones" data-role="button" data-theme="b">Save</button></div>',s+='<div class="ui-block-b"><button id="btn-canelcones" onclick="$(\'#pnl-cones\').hide();" data-role="button" data-theme="a">Cancel</button></div></div>';var l=$('<li id="pnl-cones" data-theme="c"></li>');l.append(s),l.insertAfter(e).trigger("create").find("#btn-savecones").bind("vclick",saveCones),$("input[name=radio-station]").click(function(){var e=$(this).val(),n=!1;"na"==e&&(e=0);for(var i=0;i<selectedRun.coneHits.length;i++)if(e==selectedRun.coneHits[i].station){$("#radio-cone-"+selectedRun.coneHits[i].cones).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh"),n=!0;break}n||($("#radio-cone-0").prop("checked","checked"),$("input[name=radio-cone]").checkboxradio("refresh"))}),selectedRun=n}$("#queuelist").listview("refresh")}var queueItems=[],runItems=[],showClassInNumber=!0,queueOrdering=-1,socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"queue",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("message",function(e){$('<div class="msg-message ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><h1>Message</h1><p>'+e.message+"</p><p><a onclick=\"$('.msg-message').remove();\">Close</a></div>").css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("initq",function(e){$("#queuelist").empty();if(e.length>0)for(var n=0;n<e.length;n++){var i=e[n];addToQueueList(i)}else $("#queuelist").append('<li id="ql-none"><h3>None</h3></li>');$("#queuelist").listview("refresh")}),socket.on("addq",function(e){addToQueueList(e.run),$("#queuelist").listview("refresh")}),socket.on("delq",function(e){delQueueItem(e),0==$("#queuelist li").length&&($("#queuelist").append('<li id="ql-none"><h3>None</h3></li>'),$("#queuelist").listview("refresh"))}),socket.on("cones",function(e){$("#run-"+e.rid+" p.list-conecount > span").hide().html(e.total).slideDown(300)}),advancedMode&&socket.on("conesadv",function(e){$("#run-"+e.rid+" p.list-conecount > span").hide().html(e.total).slideDown(300);var n=$("#run-"+e.rid),i=n.data("run");i.coneHits=e.coneHits,i.isDnf=i.isOff=i.getsRerun=!1,"dnf"==e.penalty&&(i.isDnf=!0,$("#pen-"+e.rid).text("DNF")),"off"==e.penalty&&(i.isOff=!0,$("#pen-"+e.rid).text("OFF")),"rerun"==e.penalty&&(i.getsRerun=!0,$("#pen-"+e.rid).text("RERUN")),("none"==e.penalty||""==e.penalty)&&$("#pen-"+e.rid).text(""),n.data("run",i)}),socket.on("initr",function(e){$("#runlist").empty();if(e.length>0)for(var n=0;n<e.length;n++){var i=e[n];addToRunList(i,!0)}else $("#runlist").append('<li id="run-none"><h3>None</h3></li>');$("#runlist").listview("refresh")}),socket.on("addr",function(e){addToRunList(e),$("#runlist").listview("refresh")}),socket.on("delr",function(e){delRunItem(e)}),advancedMode||$("#queuelist button").live("click",function(){var e=$(this),n=e.hasClass("btn-cc-add")?1:-1,i=e.data("rid");socket.emit("cones",{rid:i,inc:n,stream:"queue"})});var selectedRun=null;$("#btn-savecones").bind("vclick",saveCones),$("input[name=radio-station]").click(function(){var e=$(this).val(),n=!1;"na"==e&&(e=0);for(var i=0;i<selectedRun.coneHits.length;i++)if(e==selectedRun.coneHits[i].station){$("#radio-cone-"+selectedRun.coneHits[i].cones).prop("checked",!0),$("input[name=radio-cone]").checkboxradio("refresh"),n=!0;break}n||($("#radio-cone-0").prop("checked","checked"),$("input[name=radio-cone]").checkboxradio("refresh"))});