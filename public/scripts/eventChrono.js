function updatePenalties(){}function startTimers(){console.log("start timers"),timerId=setInterval(updateTimers,63),timerRunning=!0}function stopTimers(){console.log("stop timers"),clearInterval(timerId),timerRunning=!1}function updateTimers(){for(var e=0;e<starts.length;e++)$("#timer-"+e+" .chrono-time").html(calcTime(e))}function calcTime(e){var n=starts[e];if(void 0!==n){var t=serverStamp-n,r=(new Date).getTime()-localStamp;return((t+r)/1e3).toFixed(3)}return"-"}function setTimerBox(e,n){var t=void 0===starts[n]?"00.000":((serverStamp-starts[n])/1e3).toFixed(3),r=void 0===splits[n]?null:splits[n].toFixed(3),i="&nbsp;",o="&nbsp;",s="",u="",a=null,c=n,l="";e&&(l=e._id,i=e.driver.name,o=NaN+e.driver.carNumber+" "+e.axClass.name,s=e.driver.car.description,c=e._id,e.isOff?a="OFF":e.isDnf?a="DNF":e.getsRerun&&(a="RERUN"),e.cones>0&&(u="+"+e.cones)),$("#timer-"+n+" .chrono-time").text(t),$("#timer-"+n+" .chrono-pen").toggleClass("hidden",null==a).text(a),$("#timer-"+n+" .chrono-cones").toggleClass("hidden",""==u).text(u),$("#timer-"+n+" .chrono-pen").attr("id","pen-"+l),$("#timer-"+n+" .chrono-cones").attr("id","cones-"+l),$("#timer-"+n+" .chrono-num").html(o),$("#timer-"+n+" .chrono-name").html(i),$("#timer-"+n+" .chrono-split").toggleClass("hidden",null==r).text(null==r?"":"Split: "+r)}function gen(e){updateQueue();for(var n=((new Date).getTime(),starts.length),t=0;t<starts.length;t++){var r=queue[t];void 0!==r?setTimerBox(r,t):setTimerBox(null,t)}for(var t=n;4>t;t++)setTimerBox(null,t)}function updateQueue(){}function updateRuns(){var e=[];console.log("update runs");for(var n=0;6>n;n++){var t=runs[n];void 0!==t&&e.push(genRun(t))}$(".chrono-runs").html(e.join(""))}function genRun(e){var n=[],t=e.totalTime>0?e.totalTime.toFixed(3):"-",r=[];if(e.splitTimes.length>0&&null!=e.splitTimes[0])for(var i=0;i<e.splitTimes.length;i++)r.push(e.splitTimes[i].toFixed(3));var o="",s="",u="",a="",c=e._id,l=e.isDnf?"DNF":e.getsRerun?"RERUN":e.isOff?"OFF":"";if(e&&(o=e.driver.name,s="#"+e.driver.carNumber+" "+e.axClass.name,u=e.driver.car.description,e.cones>0||""!=l)){var d=e.cones>0?"+"+e.cones:"";a='<div class="cones">'+l+" "+d+"</div>"}return n.push('<div class="run" id="run-'+c+'">'+a+'<div class="time">'+t+'</div><div class="driver">'+s+'</div><div class="car">'+u+"</div></div>"),n.join("")}var queue=[],runs=[],participants=[],socket=io.connect("http://"+window.location.host);socket.emit("join",{stream:"queue",eventId:eventId}),socket.emit("join",{stream:"chrono",eventId:eventId}),socket.on("reconnecting",function(){$('<div class="msg-reconnect ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Reconnecting</h1></div>').css({display:"block",opacity:.96,"margin-left":"0","margin-top":"0",top:100,left:$(window).width()/2-100}).appendTo($.mobile.pageContainer).delay(100)}),socket.on("connect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})}),socket.on("reconnect",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()}),socket.emit("join",{stream:"queue",eventId:eventId})}),socket.on("reconnect_failed",function(){$(".msg-reconnect").fadeOut(400,function(){$(this).remove()})});var starts=[],splits=[],queue=[],runs=[],timers=[],serverStamp=(new Date).getTime(),localStamp=(new Date).getTime(),timerRunning=!1,timerId=null;socket.on("chrono",function(e){console.log("chrono data received: "+JSON.stringify(e)),starts=e.starts,splits=e.splits,serverStamp=e.timestamp,localStamp=(new Date).getTime(),starts.length>0?timerRunning||startTimers():stopTimers(),gen()}),socket.on("initq",function(e){e.sort(function(e,n){return e.runNumber<n.runNumber?-1:1}),queue=e,e.length>0,gen()}),socket.on("addq",function(e){queue.push(e.run),queue.sort(function(e,n){return e.runNumber<n.runNumber?-1:1}),gen()}),socket.on("delq",function(e){for(var n=[],t=0;t<queue.length;t++)queue[t]._id.toString()!=e&&n.push(queue[t]);queue=n,queue.sort(function(e,n){return e.runNumber>n.runNumber?1:-1}),gen()}),socket.on("addr",function(e){for(var n=!1,t=0;t<runs.length;t++)runs[t]._id==e._id&&(runs[t]=e,n=!0);n||runs.unshift(e),updateRuns()}),socket.on("initr",function(e){console.log("initr"),e.sort(function(e,n){return e.runNumber>n.runNumber?-1:1}),runs=e,updateRuns()}),socket.on("delr",function(e){console.log("delr");for(var n=[],t=0;t<runs.length;t++)runs[t]._id!=e&&n.push(runs[t]);runs=n,updateRuns()}),socket.on("conesadv",function(e){var n=0,t="";["off","dnf","rerun"].indexOf(e.penalty)>-1&&(t=e.penalty.toUpperCase()),n=e.total,$("#cones-"+e.rid).toggleClass("hidden",0==n).text("+"+n),$("#pen-"+e.rid).toggleClass("hidden",""==t).text(t);for(var r=!1,i=0;i<queue.length;i++)if(queue[i]._id==e.rid){queue[i].cones=e.total,queue[i].isDnf="dnf"==e.penalty,queue[i].isOff="off"==e.penalty,queue[i].getsRerun="rerun"==e.penalty,queue[i].coneHits=e.coneHits,r=!0;break}if(!r)for(var i=0;i<runs.length;i++)if(runs[i]._id==e.rid){runs[i].cones=e.total,runs[i].isDnf="dnf"==e.penalty,runs[i].isOff="off"==e.penalty,runs[i].getsRerun="rerun"==e.penalty,runs[i].coneHits=e.coneHits;break}});